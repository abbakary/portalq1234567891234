{% extends 'tracker/base.html' %}
{% load static custom_filters tz %}

{% block title %}Order {{ order.order_number }}{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="page-title">
    <div class="row">
      <div class="col-md-8">
        <h4>
          <i class="fa fa-play me-2"></i>Order {{ order.order_number }}
          {% if vehicle %}
            <small class="text-muted ms-2"><i class="fa fa-car"></i> {{ vehicle.plate_number }}</small>
          {% endif %}
        </h4>
      </div>
      <div class="col-md-4">
        <ol class="breadcrumb justify-content-end">
          <li class="breadcrumb-item"><a href="{% url 'tracker:dashboard' %}"><i class="fa fa-home"></i></a></li>
          <li class="breadcrumb-item"><a href="{% url 'tracker:started_orders_dashboard' %}">Started Orders</a></li>
          <li class="breadcrumb-item active">{{ order.order_number }}</li>
        </ol>
      </div>
    </div>
  </div>

  <!-- Status Bar - Enhanced -->
  <div class="row g-3 mb-4">
    <div class="col-12">
      <div class="card shadow-sm" style="border-left: 4px solid #667eea; border-radius: 8px; overflow: hidden;">
        <div class="card-body py-4">
          <div class="row align-items-center g-3">
            <div class="col-md-6">
              <div class="d-flex align-items-center gap-3">
                <div style="font-size: 1.5rem; color: #667eea;">
                  <i class="fa fa-clock"></i>
                </div>
                <div>
                  <small class="text-muted d-block">Order Status</small>
                  <p class="mb-1"><strong>Started</strong> <span class="badge bg-secondary ms-2">In Progress</span></p>
                  <small class="text-muted"><i class="fa fa-calendar me-1"></i>{{ order.started_at|date:"M d, Y H:i" }}</small>
                </div>
              </div>
            </div>
            <div class="col-md-6 text-md-end">
              <div class="d-flex align-items-center justify-content-md-end gap-3">
                <div style="text-align: right;">
                  <small class="text-muted d-block">Order Type</small>
                  <p class="mb-0">
                    {% if order.type == 'service' %}
                      <span class="badge bg-primary"><i class="fa fa-wrench me-1"></i>Service</span>
                    {% elif order.type == 'sales' %}
                      <span class="badge bg-success"><i class="fa fa-shopping-cart me-1"></i>Sales</span>
                    {% elif order.type == 'labour' %}
                      <span class="badge bg-info"><i class="fa fa-tools me-1"></i>Labour</span>
                    {% elif order.type == 'mixed' %}
                      <span class="badge bg-dark"><i class="fa fa-layer-group me-1"></i>Mixed</span>
                    {% elif order.type == 'unspecified' %}
                      <span class="badge bg-secondary"><i class="fa fa-question me-1"></i>Unspecified</span>
                    {% else %}
                      <span class="badge bg-secondary">{{ order.type }}</span>
                    {% endif %}
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Action Buttons - Enhanced -->
  <div class="row g-3 mb-4">
    <div class="col-12">
      <div class="card shadow-sm" style="border-radius: 8px; overflow: hidden;">
        <div class="card-body">
          <h6 class="card-title mb-3"><i class="fa fa-cogs me-2"></i>Order Actions</h6>
          <div class="row g-2">
            <!-- Edit Information -->
            <div class="col-sm-6 col-lg-3">
              <button class="btn btn-outline-info w-100" data-bs-toggle="modal" data-bs-target="#editDetailsModal" onclick="setEditMode('customer')">
                <i class="fa fa-user me-2"></i>Customer Info
              </button>
            </div>
            {% if vehicle %}
            <div class="col-sm-6 col-lg-3">
              <button class="btn btn-outline-info w-100" data-bs-toggle="modal" data-bs-target="#editDetailsModal" onclick="setEditMode('vehicle')">
                <i class="fa fa-car me-2"></i>Vehicle Info
              </button>
            </div>
            {% endif %}

            <!-- Order Management -->
            <div class="col-sm-6 col-lg-3">
              <button type="button" id="uploadInvoiceBtn" class="btn btn-primary w-100">
                <i class="fa fa-file-upload me-2"></i>Upload Invoice
              </button>
            </div>
            <div class="col-sm-6 col-lg-3">
              <button type="button" id="editOrderDetailsBtn" class="btn btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#editOrderDetailsModal">
                <i class="fa fa-list me-2"></i>Edit order details
              </button>
            </div>

            <!-- Complete Order -->
            <div class="col-sm-6 col-lg-3">
              <button type="button" id="completeOrderBtn" class="btn btn-success w-100">
                <i class="fa fa-check-circle me-2"></i>Complete Order
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Complete Order Modal - With Signature Capture -->
  <div class="modal fade" id="completeOrderModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <form id="completeOrderForm" method="post" action="{% url 'tracker:complete_order' pk=order.id %}">
          {% csrf_token %}
          <input type="hidden" name="action" value="complete_order">
          <input type="hidden" name="signature_data" id="signatureDataInput">
          <div class="modal-header bg-success text-white">
            <h5 class="modal-title"><i class="fa fa-pen me-2"></i>Complete Order & Capture Signature</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <!-- Alert when order exceeds 2 hours -->
            <div id="delayReasonAlert" class="alert alert-warning alert-dismissible fade show" style="display:none;">
              <i class="fa fa-exclamation-triangle me-2"></i>
              <strong>Order Exceeds Expected Time</strong>
              <p class="mb-0 mt-2">This order has exceeded the expected duration. You must select a delay reason before completing.</p>
            </div>

            <!-- Signature Canvas Section -->
            <div class="mb-4">
              <label class="form-label fw-bold text-dark">
                <i class="fa fa-pen me-2"></i>Customer Signature <span class="text-danger">*</span>
              </label>
              <div class="border rounded p-3 bg-light" style="border: 2px solid #dee2e6; cursor: crosshair; min-height: 200px; position: relative;">
                <canvas id="completionSignaturePad" style="display: block; width: 100%; height: 200px; border: 1px solid #ccc; border-radius: 4px; background: white; cursor: crosshair;"></canvas>
              </div>
              <div class="d-flex gap-2 mt-2">
                <button type="button" id="clearCompletionSignature" class="btn btn-sm btn-outline-secondary">
                  <i class="fa fa-eraser me-1"></i>Clear Signature
                </button>
                <small class="text-muted ms-auto align-self-center">Use mouse or touch to draw</small>
              </div>
            </div>

            <!-- Delay Reason Form -->
            <div class="mb-3" id="delayReasonSection">
              <label class="form-label fw-bold text-dark mb-2">
                <i class="fa fa-exclamation-circle me-2 text-danger"></i><span id="delayReasonLabel">Reason for Delays</span> <span id="delayReasonRequired" class="text-danger" style="display:none;">*</span><small class="fw-normal text-muted" id="delayReasonOptionalText"> (optional)</small>
              </label>

              <!-- Category Dropdown -->
              <div class="mb-2">
                <label class="form-label text-muted small">Category</label>
                <select id="delayReasonCategory" name="delay_reason_category" class="form-select">
                  <option value="">-- Select Category --</option>
                  <option value="parts">Parts-Related Delays</option>
                  <option value="technical">Technical / Diagnostic Issues</option>
                  <option value="workload">High Workload / Operational Capacity</option>
                  <option value="customer">Customer-Related Causes</option>
                  <option value="administrative">Administrative / System Issues</option>
                  <option value="quality">Quality-Control & Testing Delays</option>
                  <option value="external">External / Environmental Factors</option>
                </select>
              </div>

              <!-- Specific Reason Dropdown -->
              <div class="mb-2">
                <label class="form-label text-muted small">Specific Reason <span id="reasonRequiredBadge" class="badge bg-danger ms-2" style="display:none;">Required</span></label>
                <select id="delayReasonDropdown" name="delay_reason" class="form-select">
                  <option value="">-- Select Specific Reason --</option>
                </select>
                <div id="selectedReasonDisplay" class="alert alert-info mt-2" style="display:none;">
                  <i class="fa fa-check-circle me-2"></i>
                  <strong>Selected:</strong> <span id="selectedReasonText"></span>
                </div>
              </div>

              <!-- Custom Comments -->
              <div>
                <label class="form-label text-muted small">Additional Comments (optional)</label>
                <textarea id="delayReasonComments" name="delay_reason_comments" class="form-control form-control-sm" rows="2" placeholder="Add any additional details about the delay..."></textarea>
              </div>

              <small class="text-muted d-block mt-2">
                <i class="fa fa-info-circle me-1"></i><span id="delayReasonHelpText">Select the reason if order exceeded 2 hours.</span>
              </small>
            </div>

            <div id="delayReasonError" class="alert alert-danger" style="display:none;"></div>
          </div>
          <div class="modal-footer bg-light">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-success fw-bold">
              <i class="fa fa-check-circle me-2"></i>Complete Order
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="modal fade" id="branchMismatchModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title">Branch Mismatch</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p class="mb-2">You are viewing an order for <strong>{{ order.branch.name }}</strong> while your branch is <strong>{{ user_branch.name }}</strong>.</p>
          <p class="mb-0">Proceed only if you intend to work on this cross-branch order.</p>
        </div>
        <div class="modal-footer bg-light">
          <a href="{% url 'tracker:started_orders_dashboard' %}" class="btn btn-outline-secondary">Back to Started Orders</a>
          <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Continue</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Invoice Upload Modal (Shared/Reusable) -->
  {% include 'tracker/partials/invoice_upload_modal.html' %}

  <!-- Edit Order Details Modal - FIXED VERSION -->
  <div class="modal fade" id="editOrderDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title"><i class="fa fa-list me-2"></i>Edit Order Details</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <form id="orderDetailsForm" method="post" action="{% url 'tracker:order_edit' order.id %}">
          {% csrf_token %}
          <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
            <!-- Order Type Selection -->
            <div class="mb-4">
              <label class="form-label fw-bold">Order Type</label>
              <div class="row g-2">
                <div class="col-md-6">
                  <select id="editOrderType" name="order_type" class="form-select">
                    <option value="service" {% if order.type == 'service' %}selected{% endif %}>üîß Service</option>
                    <option value="sales" {% if order.type == 'sales' %}selected{% endif %}>üõí Sales (Items)</option>
                    <option value="labour" {% if order.type == 'labour' %}selected{% endif %}>üõ†Ô∏è Labour</option>
                    <option value="inquiry" {% if order.type == 'inquiry' %}selected{% endif %}>‚ùì Inquiry</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <div class="alert alert-info mb-0 py-2">
                    <small id="orderTypeInfo">
                      <i class="fa fa-info-circle me-1"></i>Select appropriate order type
                    </small>
                  </div>
                </div>
              </div>
            </div>

            <!-- Item Selection for Sales Orders -->
            <div id="itemSelectionSection" class="mb-4" style="display:none;">
              <div class="card border-light bg-light">
                <div class="card-body">
                  <label class="form-label fw-bold mb-3"><i class="fa fa-shopping-cart me-2"></i>Select Item</label>

                  <!-- Tab-based interface for Labour Code Lookup vs Manual Entry -->
                  <ul class="nav nav-tabs mb-3" role="tablist">
                    <li class="nav-item" role="presentation">
                      <button class="nav-link active" id="labourCodeTab" type="button" role="tab" aria-controls="labourCodePanel" aria-selected="true" data-bs-toggle="tab" data-bs-target="#labourCodePanel">
                        <i class="fa fa-database me-1"></i>Labour Code
                      </button>
                    </li>
                    <li class="nav-item" id="inventoryTabItem" role="presentation">
                      <button class="nav-link" id="inventoryTab" type="button" role="tab" aria-controls="inventoryPanel" aria-selected="false" data-bs-toggle="tab" data-bs-target="#inventoryPanel">
                        <i class="fa fa-box me-1"></i>Inventory
                      </button>
                    </li>
                    <li class="nav-item" role="presentation">
                      <button class="nav-link" id="manualEntryTab" type="button" role="tab" aria-controls="manualEntryPanel" aria-selected="false" data-bs-toggle="tab" data-bs-target="#manualEntryPanel">
                        <i class="fa fa-pen-to-square me-1"></i>Manual Entry
                      </button>
                    </li>
                  </ul>

                  <div class="tab-content">
                    <!-- Labour Code Lookup Tab -->
                    <div class="tab-pane fade show active" id="labourCodePanel" role="tabpanel">
                      <div class="mb-3">
                        <label class="form-label">Search Labour Code</label>
                        <input type="text" id="labourCodeSearch" class="form-control" placeholder="Enter labour code or item name...">
                        <small class="form-text text-muted">Type to search labour codes from database</small>
                      </div>
                      <div id="labourCodeResults" class="mb-3" style="display:none;">
                        <div class="alert alert-info mb-0 py-2">
                          <small><i class="fa fa-spinner fa-spin me-1"></i>Searching labour codes...</small>
                        </div>
                      </div>
                      <div id="labourCodeSelected" style="display:none;">
                        <div class="alert alert-success py-2">
                          <div class="d-flex justify-content-between align-items-center">
                            <div>
                              <strong id="labourCodeSelectedName">Item Name</strong><br>
                              <small>
                                Code: <span id="labourCodeSelectedCode"></span> ‚Ä¢
                                Brand: <span id="labourCodeSelectedBrand"></span>
                              </small>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-danger" id="clearLabourCodeBtn">Clear</button>
                          </div>
                        </div>
                      </div>
                      <input type="hidden" id="labourCodeId" name="labour_code_id">
                    </div>

                    <!-- Inventory Tab -->
                    <div class="tab-pane fade" id="inventoryPanel" role="tabpanel">
                      <div class="mb-3">
                        <label class="form-label">Select from Inventory</label>
                        <select id="editOrderItemSelect" name="item_id" class="form-select">
                          <option value="">Loading items...</option>
                        </select>
                        <small class="form-text text-muted">Select existing inventory items</small>
                      </div>
                      <div class="row g-2">
                        <div class="col-md-6">
                          <label class="form-label">Brand</label>
                          <input type="text" id="editOrderBrand" class="form-control" readonly>
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">Quantity</label>
                          <input type="number" id="editOrderQuantity" class="form-control" value="1" min="1">
                        </div>
                      </div>
                    </div>

                    <!-- Manual Entry Tab -->
                    <div class="tab-pane fade" id="manualEntryPanel" role="tabpanel">
                      <div class="mb-3">
                        <label class="form-label">Item Name</label>
                        <input type="text" id="itemNameManual" name="item_name_manual" class="form-control" placeholder="Enter item name...">
                      </div>
                      <div class="row g-2">
                        <div class="col-md-6">
                          <label class="form-label">Brand</label>
                          <input type="text" id="itemBrandManual" name="item_brand_manual" class="form-control" placeholder="Enter brand name...">
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">Quantity</label>
                          <input type="number" id="itemQuantityManual" name="item_quantity" class="form-control" value="1" min="1">
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Services/Add-ons Selection -->
            <div id="servicesSection" class="mb-4" style="display:none;">
              <div class="card border-light">
                <div class="card-body">
                  <label class="form-label fw-bold mb-3">
                    <i class="fa fa-check-circle me-2"></i>
                    <span id="servicesLabel">Services</span>
                  </label>
                  <div id="editServicesContainer" class="row g-2" style="max-height: 250px; overflow-y: auto; padding-right: 5px;">
                    <div class="col-12 text-muted text-center py-3">
                      <small><i class="fa fa-spinner fa-spin me-1"></i>Loading services...</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Duration -->
            <div class="mb-3">
              <label class="form-label fw-bold">Estimated Duration (minutes)</label>
              <input type="number" name="estimated_duration" id="orderEstimatedDuration" class="form-control" value="{{ order.estimated_duration|default:'' }}" min="0" placeholder="0">
              <small class="text-muted">Auto-calculated based on selected services (optional)</small>
            </div>
          </div>
          <div class="modal-footer bg-light" style="position: sticky; bottom: 0; background: #f8fafc; border-top: 1px solid #e2e8f0; padding: 1rem 2rem; z-index: 10;">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary"><i class="fa fa-save me-2"></i>Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- INLINE STYLES FOR EDIT ORDER DETAILS MODAL -->
  <style>
  /* Edit Order Details Modal Styles */
  #editOrderDetailsModal .modal-dialog {
      max-width: 900px;
      margin: 1.75rem auto;
  }
  
  #editOrderDetailsModal .modal-content {
      border: none;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
      border-radius: 12px;
      overflow: hidden;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
  }
  
  #editOrderDetailsModal .modal-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-bottom: none;
      padding: 1.5rem 2rem;
      flex-shrink: 0;
  }
  
  #editOrderDetailsModal .modal-title {
      font-weight: 600;
      font-size: 1.5rem;
  }
  
  #editOrderDetailsModal .btn-close {
      filter: invert(1) brightness(2);
      opacity: 0.8;
      transition: opacity 0.2s;
  }
  
  #editOrderDetailsModal .btn-close:hover {
      opacity: 1;
  }
  
  #editOrderDetailsModal .modal-body {
      padding: 2rem;
      flex: 1 1 auto;
      overflow-y: auto;
  }
  
  #editOrderDetailsModal .form-label.fw-bold {
      color: #2d3748;
      font-size: 1rem;
      margin-bottom: 0.75rem;
  }
  
  #editOrderDetailsModal .form-select,
  #editOrderDetailsModal .form-control {
      border: 1.5px solid #e2e8f0;
      border-radius: 8px;
      padding: 0.75rem 1rem;
      transition: all 0.3s ease;
  }
  
  #editOrderDetailsModal .form-select:focus,
  #editOrderDetailsModal .form-control:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }
  
  /* Tab Styles */
  #editOrderDetailsModal .nav-tabs {
      border-bottom: 2px solid #e2e8f0;
      margin-bottom: 1.5rem;
  }
  
  #editOrderDetailsModal .nav-tabs .nav-link {
      border: none;
      color: #718096;
      font-weight: 500;
      padding: 0.75rem 1.5rem;
      border-radius: 8px 8px 0 0;
      margin-bottom: -2px;
      transition: all 0.3s ease;
  }
  
  #editOrderDetailsModal .nav-tabs .nav-link:hover {
      color: #4a5568;
      background-color: #f7fafc;
  }
  
  #editOrderDetailsModal .nav-tabs .nav-link.active {
      color: #667eea;
      background-color: transparent;
      border-bottom: 3px solid #667eea;
      font-weight: 600;
  }
  
  /* Service/Labour Code Cards */
  .service-checkbox-card, .labour-code-checkbox-card {
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      background: white;
      margin-bottom: 10px;
      overflow: hidden;
  }
  
  .service-checkbox-card:hover, .labour-code-checkbox-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
      border-color: #667eea;
  }
  
  .service-checkbox-card.selected, .labour-code-checkbox-card.selected {
      border-color: #667eea;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(102, 126, 234, 0.02) 100%);
      box-shadow: 0 4px 8px rgba(102, 126, 234, 0.15), inset 0 0 0 2px #667eea;
  }
  
  .service-checkbox-card .card-body, .labour-code-checkbox-card .card-body {
      padding: 0.75rem;
      position: relative;
  }
  
  .service-checkbox-card .form-check-input,
  .labour-code-checkbox-card .form-check-input {
      position: absolute;
      width: 100%;
      height: 100%;
      opacity: 0;
      z-index: 2;
      cursor: pointer;
      top: 0;
      left: 0;
  }
  
  .service-checkbox-card .check-icon,
  .labour-code-checkbox-card .check-icon {
      position: absolute;
      top: 8px;
      right: 8px;
      color: #10b981;
      font-size: 0.9rem;
      opacity: 0;
      transition: opacity 0.3s ease;
  }
  
  .service-checkbox-card.selected .check-icon,
  .labour-code-checkbox-card.selected .check-icon {
      opacity: 1;
  }
  
  /* Compact Card Content */
  .service-checkbox-card .card-body .fa-lg,
  .labour-code-checkbox-card .card-body .fa-lg {
      font-size: 1rem !important;
  }
  
  .service-checkbox-card h6,
  .labour-code-checkbox-card h6 {
      font-size: 0.85rem !important;
      line-height: 1.3;
      margin-bottom: 0.2rem !important;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
  }
  
  .service-checkbox-card small,
  .labour-code-checkbox-card small {
      font-size: 0.75rem !important;
  }
  
  /* Services Container Scroll */
  #editServicesContainer {
      max-height: 250px;
      overflow-y: auto;
      padding-right: 10px;
  }
  
  #editServicesContainer::-webkit-scrollbar {
      width: 6px;
  }
  
  #editServicesContainer::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
  }
  
  #editServicesContainer::-webkit-scrollbar-thumb {
      background: #cbd5e0;
      border-radius: 4px;
  }
  
  #editServicesContainer::-webkit-scrollbar-thumb:hover {
      background: #a0aec0;
  }
  
  /* Labour Code Results */
  #labourCodeResults {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 0.75rem;
      background: #f8fafc;
  }
  
  #labourCodeResults button {
      text-align: left;
      white-space: normal;
      padding: 0.5rem;
      margin-bottom: 0.5rem;
      border-radius: 6px;
      transition: all 0.2s;
      width: 100%;
      background: white;
      border: 1px solid #e2e8f0;
      font-size: 0.9rem;
  }
  
  #labourCodeResults button:hover {
      background-color: #667eea;
      color: white;
      transform: translateX(2px);
      border-color: #667eea;
  }
  
  /* Modal Footer */
  #editOrderDetailsModal .modal-footer {
      background: #f8fafc;
      border-top: 1px solid #e2e8f0;
      padding: 1rem 2rem;
      flex-shrink: 0;
  }
  
  #editOrderDetailsModal .modal-footer .btn {
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.3s ease;
  }
  
  #editOrderDetailsModal .modal-footer .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
  }
  
  #editOrderDetailsModal .modal-footer .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
  }
  
  /* Scrollbar Styling for Modal Body */
  #editOrderDetailsModal .modal-body::-webkit-scrollbar {
      width: 8px;
  }
  
  #editOrderDetailsModal .modal-body::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
  }
  
  #editOrderDetailsModal .modal-body::-webkit-scrollbar-thumb {
      background: #cbd5e0;
      border-radius: 4px;
  }
  
  #editOrderDetailsModal .modal-body::-webkit-scrollbar-thumb:hover {
      background: #a0aec0;
  }
  
  /* Responsive */
  @media (max-width: 768px) {
      #editOrderDetailsModal .modal-dialog {
          margin: 0.5rem;
          max-width: calc(100% - 1rem);
      }
      
      #editOrderDetailsModal .modal-body {
          padding: 1.5rem;
      }
      
      #editOrderDetailsModal .nav-tabs .nav-link {
          padding: 0.5rem 1rem;
          font-size: 0.9rem;
      }
      
      .service-checkbox-card, .labour-code-checkbox-card {
          margin-bottom: 0.75rem;
      }
      
      #editServicesContainer {
          max-height: 200px;
      }
      
      #editOrderDetailsModal .modal-footer {
          padding: 1rem;
      }
      
      #editOrderDetailsModal .modal-footer .btn {
          padding: 0.5rem 1rem;
          font-size: 0.9rem;
      }
  }
  </style>

  <!-- Tab Navigation -->
  <ul class="nav nav-tabs mb-3" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
        <i class="fa fa-eye me-2"></i>Overview
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab">
        <i class="fa fa-list me-2"></i>Order Details
      </button>
    </li>
  </ul>

  <!-- Tab Content -->
  <div class="tab-content">
    <!-- Overview Tab -->
    <div class="tab-pane fade show active" id="overview">
      <div class="row g-3">
        <div class="col-lg-6">
          <div class="card shadow-sm">
            <div class="card-header bg-light">
              <h6 class="mb-0"><i class="fa fa-user me-2"></i>Customer Information</h6>
            </div>
            <div class="card-body">
              <div class="list-group list-group-flush">
                <div class="list-group-item px-0">
                  <small class="text-muted d-block">Name</small>
                  <strong>{{ customer.full_name }}</strong>
                </div>
                <div class="list-group-item px-0">
                  <small class="text-muted d-block">Phone</small>
                  <strong><a href="tel:{{ customer.phone }}">{{ customer.phone }}</a></strong>
                </div>
                {% if customer.email %}
                <div class="list-group-item px-0">
                  <small class="text-muted d-block">Email</small>
                  <strong><a href="mailto:{{ customer.email }}">{{ customer.email }}</a></strong>
                </div>
                {% endif %}
                {% if customer.address %}
                <div class="list-group-item px-0">
                  <small class="text-muted d-block">Address</small>
                  <strong>{{ customer.address }}</strong>
                </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-6">
          <div class="card shadow-sm">
            <div class="card-header bg-light">
              <h6 class="mb-0"><i class="fa fa-car me-2"></i>Vehicle Information</h6>
            </div>
            <div class="card-body">
              {% if vehicle %}
              <div class="list-group list-group-flush">
                <div class="list-group-item px-0">
                  <small class="text-muted d-block">Plate Number</small>
                  <strong>{{ vehicle.plate_number }}</strong>
                </div>
                {% if vehicle.make %}
                <div class="list-group-item px-0">
                  <small class="text-muted d-block">Make</small>
                  <strong>{{ vehicle.make }}</strong>
                </div>
                {% endif %}
                {% if vehicle.model %}
                <div class="list-group-item px-0">
                  <small class="text-muted d-block">Model</small>
                  <strong>{{ vehicle.model }}</strong>
                </div>
                {% endif %}
                {% if vehicle.vehicle_type %}
                <div class="list-group-item px-0">
                  <small class="text-muted d-block">Type</small>
                  <strong>{{ vehicle.vehicle_type }}</strong>
                </div>
                {% endif %}
              </div>
              {% else %}
              <div class="alert alert-warning" role="alert">
                <i class="fa fa-exclamation-triangle me-2"></i>No vehicle information
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Details Tab -->
    <div class="tab-pane fade" id="details">
      <div class="card shadow-sm">
        <div class="card-body">
          {% if order.description %}
          <div class="mb-3">
            <small class="text-muted d-block">Description</small>
            <strong>{{ order.description }}</strong>
          </div>
          {% endif %}
          {% if order.estimated_duration %}
          <div class="mb-3">
            <small class="text-muted d-block">Estimated Duration</small>
            <strong>{{ order.estimated_duration }} minutes</strong>
          </div>
          {% endif %}
          {% if order.item_name %}
          <div class="mb-3">
            <small class="text-muted d-block">Item</small>
            <strong>{{ order.item_name }}</strong>
          </div>
          {% endif %}
          {% if order.brand %}
          <div class="mb-3">
            <small class="text-muted d-block">Brand</small>
            <strong>{{ order.brand }}</strong>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Include Extraction Form Modal -->
{% include 'tracker/modals/extraction_form_modal.html' %}

<!-- Unified Edit Details Modal -->
<div class="modal fade" id="editDetailsModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title"><i class="fa fa-edit me-2"></i><span id="editTitle">Edit Details</span></h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <!-- Customer Edit Form -->
      <form id="customerEditForm" method="post" style="display: none;">
        {% csrf_token %}
        <input type="hidden" name="action" value="update_customer">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label fw-bold">Full Name</label>
            <input type="text" name="full_name" class="form-control" value="{{ customer.full_name }}" required>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Phone</label>
            <input type="tel" name="phone" class="form-control" value="{{ customer.phone }}" required>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Email</label>
            <input type="email" name="email" class="form-control" value="{{ customer.email|default:'' }}">
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Address</label>
            <textarea name="address" class="form-control" rows="2">{{ customer.address|default:'' }}</textarea>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Customer Type</label>
            <select name="customer_type" id="editCustomerType" class="form-select">
              <option value="personal" {% if customer.customer_type == 'personal' %}selected{% endif %}>Personal</option>
              <option value="company" {% if customer.customer_type == 'company' %}selected{% endif %}>Company</option>
              <option value="government" {% if customer.customer_type == 'government' %}selected{% endif %}>Government</option>
              <option value="ngo" {% if customer.customer_type == 'ngo' %}selected{% endif %}>NGO</option>
            </select>
          </div>
          <div class="mb-3 {% if customer.customer_type != 'personal' %}d-none{% endif %}" id="editPersonalSubtypeField">
            <label class="form-label fw-bold">Personal Subtype</label>
            <select name="personal_subtype" class="form-select">
              <option value="owner" {% if customer.personal_subtype == 'owner' %}selected{% endif %}>Owner</option>
              <option value="driver" {% if customer.personal_subtype == 'driver' %}selected{% endif %}>Driver</option>
            </select>
          </div>
          <div class="mb-3 {% if customer.customer_type == 'personal' %}d-none{% endif %}" id="editOrganizationField">
            <label class="form-label fw-bold">Organization Name</label>
            <input type="text" name="organization_name" class="form-control" value="{{ customer.organization_name|default:'' }}">
          </div>
          <div class="mb-3 {% if customer.customer_type == 'personal' %}d-none{% endif %}" id="editTaxField">
            <label class="form-label fw-bold">Tax Number (TIN)</label>
            <input type="text" name="tax_number" class="form-control" value="{{ customer.tax_number|default:'' }}">
          </div>
        </div>
        <div class="modal-footer bg-light">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>

      <!-- Vehicle Edit Form -->
      {% if vehicle %}
      <form id="vehicleEditForm" method="post" style="display: none;">
        {% csrf_token %}
        <input type="hidden" name="action" value="update_vehicle">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label fw-bold">Plate Number</label>
            <input type="text" class="form-control" value="{{ vehicle.plate_number }}" readonly>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Vehicle Type</label>
            <input type="text" name="vehicle_type" class="form-control" value="{{ vehicle.vehicle_type|default:'' }}">
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Make</label>
            <input type="text" name="make" class="form-control" value="{{ vehicle.make|default:'' }}">
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Model</label>
            <input type="text" name="model" class="form-control" value="{{ vehicle.model|default:'' }}">
          </div>
        </div>
        <div class="modal-footer bg-light">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
      {% endif %}
    </div>
  </div>
</div>

<script>
let currentEditMode = 'customer';

function setEditMode(mode) {
  currentEditMode = mode;

  // Hide all forms
  document.getElementById('customerEditForm').style.display = 'none';
  if (document.getElementById('vehicleEditForm')) {
    document.getElementById('vehicleEditForm').style.display = 'none';
  }

  // Show selected form
  if (mode === 'customer') {
    document.getElementById('editTitle').textContent = 'Edit Customer Information';
    document.getElementById('customerEditForm').style.display = 'block';
    if (typeof toggleCustomerExtraFields === 'function') { toggleCustomerExtraFields(); }
  } else if (mode === 'vehicle') {
    document.getElementById('editTitle').textContent = 'Edit Vehicle Information';
    document.getElementById('vehicleEditForm').style.display = 'block';
  }
}

function toggleCustomerExtraFields(){
  var sel = document.getElementById('editCustomerType');
  var type = sel ? String(sel.value).toLowerCase() : '';
  var personal = document.getElementById('editPersonalSubtypeField');
  var org = document.getElementById('editOrganizationField');
  var tax = document.getElementById('editTaxField');
  if (personal) {
    if (type === 'personal') { personal.classList.remove('d-none'); } else { personal.classList.add('d-none'); }
  }
  var showOrg = (type === 'company' || type === 'government' || type === 'ngo');
  if (org) { if (showOrg) { org.classList.remove('d-none'); } else { org.classList.add('d-none'); } }
  if (tax) { if (showOrg) { tax.classList.remove('d-none'); } else { tax.classList.add('d-none'); } }
}

document.addEventListener('DOMContentLoaded', function(){
  var sel = document.getElementById('editCustomerType');
  if (sel) {
    sel.addEventListener('change', toggleCustomerExtraFields);
    toggleCustomerExtraFields();
  }
  var editModal = document.getElementById('editDetailsModal');
  if (editModal) {
    editModal.addEventListener('shown.bs.modal', function(){
      var typeSel = document.getElementById('editCustomerType');
      if (typeSel) {
        typeSel.removeEventListener('change', toggleCustomerExtraFields);
        typeSel.addEventListener('change', toggleCustomerExtraFields);
        toggleCustomerExtraFields();
      }
    });
  }
});

// Edit Order Details Modal Initialize and Handle
document.addEventListener('DOMContentLoaded', function(){
  const editOrderModal = document.getElementById('editOrderDetailsModal');
  const editOrderTypeEl = document.getElementById('editOrderType');
  const itemSelectionSection = document.getElementById('itemSelectionSection');
  const servicesSection = document.getElementById('servicesSection');
  const servicesLabel = document.getElementById('servicesLabel');
  const editServicesContainer = document.getElementById('editServicesContainer');
  const editOrderItemSelect = document.getElementById('editOrderItemSelect');
  const editOrderBrand = document.getElementById('editOrderBrand');
  const orderTypeInfo = document.getElementById('orderTypeInfo');
  const orderDetailsForm = document.getElementById('orderDetailsForm');
  const labourCodeSearch = document.getElementById('labourCodeSearch');
  const labourCodeResults = document.getElementById('labourCodeResults');
  const labourCodeSelected = document.getElementById('labourCodeSelected');
  const labourCodeId = document.getElementById('labourCodeId');
  const clearLabourCodeBtn = document.getElementById('clearLabourCodeBtn');

  let allServices = { service_types: [], service_addons: [], inventory_items: [], labour_codes: [] };

  function loadServicesAndItems() {
    fetch('/tracker/api/orders/service-types/', {
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(r => r.json())
    .then(data => {
      allServices = data;
      updateOrderTypeUI();
      populateItemDropdown();
    })
    .catch(err => {
      console.error('Error loading services:', err);
      editServicesContainer.innerHTML = '<div class="col-12 text-danger"><small>Failed to load services</small></div>';
    });
  }

  function updateOrderTypeUI() {
    const selectedType = editOrderTypeEl.value;
    const inventoryTabItem = document.getElementById('inventoryTabItem');
    const typeInfoMap = {
      'service': 'Service order - Select labour codes or services to perform',
      'sales': 'Sales order - Select item/tire to sell',
      'labour': 'Labour order - Select labour codes for charges',
      'inquiry': 'Inquiry - Follow-up with customer'
    };
    orderTypeInfo.textContent = '‚úì ' + (typeInfoMap[selectedType] || 'Select appropriate order type');

    if (selectedType === 'sales') {
      itemSelectionSection.style.display = 'block';
      servicesLabel.textContent = 'Add-ons';
      renderServices(allServices.service_addons || [], 'addon');
      servicesSection.style.display = 'block';
      if (inventoryTabItem) inventoryTabItem.style.display = 'none';
    } else if (selectedType === 'service') {
      itemSelectionSection.style.display = 'none';
      servicesLabel.textContent = 'Labour Codes';
      renderLabourCodes(allServices.labour_codes || [], 'service');
      servicesSection.style.display = 'block';
      if (inventoryTabItem) inventoryTabItem.style.display = 'block';
    } else if (selectedType === 'labour') {
      itemSelectionSection.style.display = 'none';
      servicesLabel.textContent = 'Labour Codes';
      renderLabourCodes(allServices.labour_codes || [], 'labour');
      servicesSection.style.display = 'block';
      if (inventoryTabItem) inventoryTabItem.style.display = 'block';
    } else {
      itemSelectionSection.style.display = 'none';
      servicesSection.style.display = 'none';
      if (inventoryTabItem) inventoryTabItem.style.display = 'block';
    }
  }

  function renderServices(services, type) {
    editServicesContainer.innerHTML = '';
    if (!services || services.length === 0) {
      editServicesContainer.innerHTML = '<div class="col-12 text-muted text-center py-3"><small><i class="fa fa-inbox me-2"></i>No ' + (type === 'addon' ? 'add-ons' : 'services') + ' available</small></div>';
      return;
    }
    services.forEach((service, index) => {
      const col = document.createElement('div');
      col.className = 'col-md-6 col-lg-4';
      const checkboxId = `edit_svc_${service.id || service.name.replace(/\s+/g, '_')}`;
      const icon = type === 'addon' ? 'fa-plus-circle' : 'fa-wrench';
      const color = type === 'addon' ? '#9b59b6' : '#3498db';
      const minutes = service.estimated_minutes || 0;

      col.innerHTML = `
        <div class="service-checkbox-card" data-service-id="${service.id || index}">
          <div class="card-body">
            <div class="form-check mb-0">
              <input class="form-check-input" type="checkbox" id="${checkboxId}" name="services[]" value="${service.id || service.name}" data-name="${service.name}" data-minutes="${minutes}">
              <label class="form-check-label w-100 mb-0" for="${checkboxId}">
                <div class="d-flex align-items-center">
                  <div class="flex-shrink-0 me-2"><i class="fa ${icon}" style="color: ${color}; font-size: 0.9rem;"></i></div>
                  <div class="flex-grow-1" style="min-width: 0;">
                    <h6 class="mb-0" title="${service.name}">${service.name}</h6>
                    ${minutes > 0 ? `<small class="text-muted"><i class="fa fa-clock me-1"></i>${minutes} min</small>` : ''}
                  </div>
                </div>
              </label>
              <i class="fa fa-check-circle check-icon"></i>
            </div>
          </div>
        </div>
      `;
      editServicesContainer.appendChild(col);

      const card = col.querySelector('.service-checkbox-card');
      const checkbox = col.querySelector('input[type="checkbox"]');
      card.addEventListener('click', function(e) {
        if (e.target.type === 'checkbox') return;
        checkbox.checked = !checkbox.checked;
        updateCardSelection(card, checkbox.checked);
      });
      checkbox.addEventListener('change', function() {
        updateCardSelection(card, this.checked);
      });
    });
  }

  function renderLabourCodes(labourCodes, type) {
    editServicesContainer.innerHTML = '';
    if (!labourCodes || labourCodes.length === 0) {
      editServicesContainer.innerHTML = '<div class="col-12 text-muted text-center py-3"><small><i class="fa fa-tools me-2"></i>No labour codes available</small></div>';
      return;
    }
    labourCodes.forEach((lc, index) => {
      const col = document.createElement('div');
      col.className = 'col-md-6 col-lg-4';
      const checkboxId = `edit_lc_${lc.id || index}`;
      let categoryIcon = 'fa-tools';
      let categoryColor = '#667eea';
      const category = (lc.category || '').toLowerCase();
      if (category.includes('labour')) { categoryIcon = 'fa-hammer'; categoryColor = '#e74c3c'; }
      else if (category.includes('service')) { categoryIcon = 'fa-wrench'; categoryColor = '#3498db'; }
      else if (category.includes('sales')) { categoryIcon = 'fa-shopping-cart'; categoryColor = '#27ae60'; }

      col.innerHTML = `
        <div class="labour-code-checkbox-card" data-labour-code-id="${lc.id || index}">
          <div class="card-body">
            <div class="form-check mb-0">
              <input class="form-check-input" type="checkbox" id="${checkboxId}" name="labour_codes[]" value="${lc.id}" data-code="${lc.code}" data-name="${lc.item_name || lc.description}" data-brand="${lc.brand || 'N/A'}">
              <label class="form-check-label w-100 mb-0" for="${checkboxId}">
                <div class="d-flex align-items-center">
                  <div class="flex-shrink-0 me-2"><i class="fa ${categoryIcon}" style="color: ${categoryColor}; font-size: 0.9rem;"></i></div>
                  <div class="flex-grow-1" style="min-width: 0;">
                    <h6 class="mb-0" title="${lc.item_name || lc.description}">${lc.item_name || lc.description}</h6>
                    <small class="text-muted d-block"><strong>Code:</strong> ${lc.code}</small>
                  </div>
                </div>
              </label>
              <i class="fa fa-check-circle check-icon"></i>
            </div>
          </div>
        </div>
      `;
      editServicesContainer.appendChild(col);

      const card = col.querySelector('.labour-code-checkbox-card');
      const checkbox = col.querySelector('input[type="checkbox"]');
      card.addEventListener('click', function(e) {
        if (e.target.type === 'checkbox') return;
        checkbox.checked = !checkbox.checked;
        updateCardSelection(card, checkbox.checked);
      });
      checkbox.addEventListener('change', function() {
        updateCardSelection(card, this.checked);
      });
    });
  }

  function updateCardSelection(card, isSelected) {
    if (isSelected) {
      card.classList.add('selected');
    } else {
      card.classList.remove('selected');
    }
  }

  function populateItemDropdown() {
    const items = allServices.inventory_items || [];
    editOrderItemSelect.innerHTML = '<option value="">Select item...</option>';
    items.forEach(item => {
      const option = document.createElement('option');
      option.value = item.id;
      option.textContent = `${item.name} (${item.brand})`;
      editOrderItemSelect.appendChild(option);
    });
  }

  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  const searchLabourCodes = debounce(function() {
    const searchTerm = labourCodeSearch.value.trim();
    if (!searchTerm || searchTerm.length < 2) {
      labourCodeResults.style.display = 'none';
      return;
    }
    fetch(`/tracker/api/orders/lookup-labour-code/?item_name=${encodeURIComponent(searchTerm)}`, {
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(r => r.json())
    .then(data => {
      if (data.success && data.labour_codes && data.labour_codes.length > 0) {
        labourCodeResults.innerHTML = '';
        data.labour_codes.forEach(lc => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'btn btn-light w-100 text-start mb-2 p-2';
          btn.style.border = '1px solid #e2e8f0';
          btn.style.borderRadius = '6px';
          btn.style.fontSize = '0.9rem';
          btn.innerHTML = `<strong>${lc.item_name || lc.description}</strong><br><small class="text-muted">Code: ${lc.code} ‚Ä¢ Brand: ${lc.brand || 'N/A'}</small>`;
          btn.onclick = function(e) { e.preventDefault(); selectLabourCode(lc); };
          labourCodeResults.appendChild(btn);
        });
        labourCodeResults.style.display = 'block';
      } else {
        labourCodeResults.innerHTML = `<div class="alert alert-warning mb-0 p-2"><i class="fa fa-search me-2"></i>No labour codes found for "${searchTerm}"</div>`;
        labourCodeResults.style.display = 'block';
      }
    })
    .catch(error => {
      console.error('Error searching labour codes:', error);
      labourCodeResults.innerHTML = `<div class="alert alert-danger mb-0 p-2"><i class="fa fa-exclamation-triangle me-2"></i>Error searching labour codes</div>`;
      labourCodeResults.style.display = 'block';
    });
  }, 500);

  function selectLabourCode(lc) {
    labourCodeId.value = lc.id;
    document.getElementById('labourCodeSelectedCode').textContent = lc.code;
    document.getElementById('labourCodeSelectedName').textContent = lc.item_name || lc.description;
    document.getElementById('labourCodeSelectedBrand').textContent = lc.brand || 'N/A';
    labourCodeResults.style.display = 'none';
    labourCodeSearch.value = lc.item_name || lc.description;
    labourCodeSelected.style.display = 'block';
  }

  if (clearLabourCodeBtn) {
    clearLabourCodeBtn.addEventListener('click', function(e) {
      e.preventDefault();
      labourCodeId.value = '';
      labourCodeSearch.value = '';
      labourCodeSelected.style.display = 'none';
      labourCodeResults.style.display = 'none';
    });
  }

  if (labourCodeSearch) {
    labourCodeSearch.addEventListener('input', searchLabourCodes);
  }

  if (editOrderTypeEl) {
    editOrderTypeEl.addEventListener('change', updateOrderTypeUI);
  }

  if (orderDetailsForm) {
    orderDetailsForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      const submitBtn = this.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<i class="fa fa-spinner fa-spin me-2"></i>Saving...';
      submitBtn.disabled = true;

      fetch(this.action, {
        method: 'POST',
        body: formData,
        headers: { 'X-CSRFToken': getCSRFToken(), 'X-Requested-With': 'XMLHttpRequest' }
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          alert('Order details updated successfully!');
          setTimeout(() => {
            const modal = bootstrap.Modal.getInstance(editOrderModal);
            if (modal) modal.hide();
            window.location.reload();
          }, 500);
        } else {
          alert(data.message || 'Failed to update order details.');
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        }
      })
      .catch(error => {
        console.error('Error submitting form:', error);
        alert('An error occurred. Please try again.');
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      });
    });
  }

  function getCSRFToken() {
    const name = 'csrftoken';
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  loadServicesAndItems();
});

// Signature Pad and Complete Order Logic
function initializeSignaturePad() {
  const canvas = document.getElementById('completionSignaturePad');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  let isDrawing = false;
  let lastX = 0;
  let lastY = 0;

  function resizeCanvas() {
    const container = canvas.parentElement;
    const rect = container.getBoundingClientRect();
    canvas.width = rect.width - 8;
    canvas.height = 200;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.lineWidth = 2;
    ctx.strokeStyle = '#000';
  }
  resizeCanvas();

  function getCoordinates(e) {
    const rect = canvas.getBoundingClientRect();
    const x = (e.clientX || e.touches?.[0]?.clientX) - rect.left;
    const y = (e.clientY || e.touches?.[0]?.clientY) - rect.top;
    return { x, y };
  }

  function startDrawing(e) {
    isDrawing = true;
    const { x, y } = getCoordinates(e);
    lastX = x;
    lastY = y;
  }

  function draw(e) {
    if (!isDrawing) return;
    e.preventDefault();
    const { x, y } = getCoordinates(e);
    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(x, y);
    ctx.stroke();
    lastX = x;
    lastY = y;
  }

  function stopDrawing() {
    isDrawing = false;
  }

  canvas.addEventListener('mousedown', startDrawing);
  canvas.addEventListener('mousemove', draw);
  canvas.addEventListener('mouseup', stopDrawing);
  canvas.addEventListener('mouseleave', stopDrawing);
  canvas.addEventListener('touchstart', startDrawing, { passive: false });
  canvas.addEventListener('touchmove', draw, { passive: false });
  canvas.addEventListener('touchend', stopDrawing, { passive: false });

  const clearBtn = document.getElementById('clearCompletionSignature');
  if (clearBtn) {
    clearBtn.addEventListener('click', function(e) {
      e.preventDefault();
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    });
  }
}

document.addEventListener('DOMContentLoaded', function(){
  initializeSignaturePad();
  const completeBtn = document.getElementById('completeOrderBtn');
  if (!completeBtn) return;

  const completeOrderModalEl = document.getElementById('completeOrderModal');
  const completeOrderForm = document.getElementById('completeOrderForm');
  const delayReasonCategory = document.getElementById('delayReasonCategory');
  const delayReasonDropdown = document.getElementById('delayReasonDropdown');
  const delayReasonAlert = document.getElementById('delayReasonAlert');
  const delayReasonError = document.getElementById('delayReasonError');

  const delayReasonsByCategoryJson = {};
  try {
    const delayReasonsData = {{ delay_reasons_by_category|safe }};
    if (typeof delayReasonsData === 'string') {
      Object.assign(delayReasonsByCategoryJson, JSON.parse(delayReasonsData));
    } else {
      Object.assign(delayReasonsByCategoryJson, delayReasonsData);
    }
  } catch (e) {
    console.error('Error parsing delay reasons:', e);
  }

  const exceeds9Hours = {{ exceeds_9_hours|lower }};

  function populateReasons(category) {
    delayReasonDropdown.innerHTML = '<option value="">-- Select Specific Reason --</option>';
    if (category && delayReasonsByCategoryJson[category]) {
      delayReasonsByCategoryJson[category].forEach(reason => {
        const option = document.createElement('option');
        option.value = reason.id;
        option.textContent = reason.reason_text;
        delayReasonDropdown.appendChild(option);
      });
    }
  }

  if (delayReasonCategory) {
    delayReasonCategory.addEventListener('change', function() {
      populateReasons(this.value);
      delayReasonDropdown.value = '';
    });
  }

  if (completeOrderForm) {
    completeOrderForm.addEventListener('submit', function(e) {
      e.preventDefault();
      delayReasonError.style.display = 'none';
      const canvas = document.getElementById('completionSignaturePad');
      const signatureDataInput = document.getElementById('signatureDataInput');
      if (canvas) {
        try {
          const signatureDataUrl = canvas.toDataURL('image/png', 0.8);
          signatureDataInput.value = signatureDataUrl;
        } catch (err) {
          console.warn('Could not capture signature:', err);
        }
      }
      completeOrderForm.submit();
    });
  }

  completeBtn.addEventListener('click', function(e) {
    e.preventDefault();
    if (completeOrderModalEl) {
      new bootstrap.Modal(completeOrderModalEl).show();
    }
  });
});

// Branch Mismatch Modal
document.addEventListener('DOMContentLoaded', function(){
  try {
    var mismatch = {{ branch_mismatch|yesno:'true,false' }};
    if (mismatch) {
      var bmEl = document.getElementById('branchMismatchModal');
      if (bmEl) { new bootstrap.Modal(bmEl).show(); }
    }
  } catch(e){}
});
</script>

{% endblock %}
