{% extends 'tracker/base.html' %}
{% load static custom_filters tz %}

{% block title %}Order {{ order.order_number }}{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="page-title">
    <div class="row">
      <div class="col-md-8">
        <h4>
          <i class="fa fa-play me-2"></i>Order {{ order.order_number }}
          {% if vehicle %}
            <small class="text-muted ms-2"><i class="fa fa-car"></i> {{ vehicle.plate_number }}</small>
          {% endif %}
        </h4>
      </div>
      <div class="col-md-4">
        <ol class="breadcrumb justify-content-end">
          <li class="breadcrumb-item"><a href="{% url 'tracker:dashboard' %}"><i class="fa fa-home"></i></a></li>
          <li class="breadcrumb-item"><a href="{% url 'tracker:started_orders_dashboard' %}">Started Orders</a></li>
          <li class="breadcrumb-item active">{{ order.order_number }}</li>
        </ol>
      </div>
    </div>
  </div>

  <!-- Status Bar -->
  <div class="row g-3 mb-4">
    <div class="col-12">
      <div class="card shadow-sm" style="border-left: 4px solid #667eea; border-radius: 8px; overflow: hidden;">
        <div class="card-body py-4">
          <div class="row align-items-center g-3">
            <div class="col-md-6">
              <div class="d-flex align-items-center gap-3">
                <div style="font-size: 1.5rem; color: #667eea;">
                  <i class="fa fa-clock"></i>
                </div>
                <div>
                  <small class="text-muted d-block">Order Status</small>
                  <p class="mb-1"><strong>Started</strong> <span class="badge bg-secondary ms-2">In Progress</span></p>
                  <small class="text-muted"><i class="fa fa-calendar me-1"></i>{{ order.started_at|date:"M d, Y H:i" }}</small>
                </div>
              </div>
            </div>
            <div class="col-md-6 text-md-end">
              <div class="d-flex align-items-center justify-content-md-end gap-3">
                <div style="text-align: right;">
                  <small class="text-muted d-block">Order Type</small>
                  <p class="mb-0">
                    {% if order.type == 'service' %}
                      <span class="badge bg-primary"><i class="fa fa-wrench me-1"></i>Service</span>
                    {% elif order.type == 'sales' %}
                      <span class="badge bg-success"><i class="fa fa-shopping-cart me-1"></i>Sales</span>
                    {% elif order.type == 'labour' %}
                      <span class="badge bg-info"><i class="fa fa-tools me-1"></i>Labour</span>
                    {% elif order.type == 'mixed' %}
                      <span class="badge bg-dark"><i class="fa fa-layer-group me-1"></i>Mixed</span>
                    {% elif order.type == 'unspecified' %}
                      <span class="badge bg-secondary"><i class="fa fa-question me-1"></i>Unspecified</span>
                    {% else %}
                      <span class="badge bg-secondary">{{ order.type }}</span>
                    {% endif %}
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Action Buttons -->
  <div class="row g-3 mb-4">
    <div class="col-12">
      <div class="card shadow-sm" style="border-radius: 8px; overflow: hidden;">
        <div class="card-body">
          <h6 class="card-title mb-3"><i class="fa fa-cogs me-2"></i>Order Actions</h6>
          <div class="row g-2">
            <div class="col-sm-6 col-lg-3">
              <button class="btn btn-outline-info w-100" data-bs-toggle="modal" data-bs-target="#editDetailsModal" onclick="setEditMode('customer')">
                <i class="fa fa-user me-2"></i>Customer Info
              </button>
            </div>
            {% if vehicle %}
            <div class="col-sm-6 col-lg-3">
              <button class="btn btn-outline-info w-100" data-bs-toggle="modal" data-bs-target="#editDetailsModal" onclick="setEditMode('vehicle')">
                <i class="fa fa-car me-2"></i>Vehicle Info
              </button>
            </div>
            {% endif %}
            <div class="col-sm-6 col-lg-3">
              <button type="button" id="uploadInvoiceBtn" class="btn btn-primary w-100">
                <i class="fa fa-file-upload me-2"></i>Upload Invoice
              </button>
            </div>
            <div class="col-sm-6 col-lg-3">
              <button type="button" id="editOrderDetailsBtn" class="btn btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#editOrderDetailsModal">
                <i class="fa fa-list me-2"></i>Edit order details
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Complete Order Modal -->
  <div class="modal fade" id="completeOrderModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <form id="completeOrderForm" method="post" action="{% url 'tracker:complete_order' pk=order.id %}">
          {% csrf_token %}
          <input type="hidden" name="action" value="complete_order">
          <input type="hidden" name="signature_data" id="signatureDataInput">
          <div class="modal-header bg-success text-white">
            <h5 class="modal-title"><i class="fa fa-pen me-2"></i>Complete Order & Capture Signature</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div id="delayReasonAlert" class="alert alert-warning alert-dismissible fade show" style="display:none;">
              <i class="fa fa-exclamation-triangle me-2"></i>
              <strong>Order Exceeds Expected Time</strong>
              <p class="mb-0 mt-2">This order has exceeded the expected duration. You must select a delay reason before completing.</p>
            </div>

            <div class="mb-4">
              <label class="form-label fw-bold text-dark">
                <i class="fa fa-pen me-2"></i>Customer Signature <span class="text-danger">*</span>
              </label>
              <div class="border rounded p-3 bg-light" style="border: 2px solid #dee2e6; cursor: crosshair; min-height: 200px; position: relative;">
                <canvas id="completionSignaturePad" style="display: block; width: 100%; height: 200px; border: 1px solid #ccc; border-radius: 4px; background: white; cursor: crosshair;"></canvas>
              </div>
              <div class="d-flex gap-2 mt-2">
                <button type="button" id="clearCompletionSignature" class="btn btn-sm btn-outline-secondary">
                  <i class="fa fa-eraser me-1"></i>Clear Signature
                </button>
                <small class="text-muted ms-auto align-self-center">Use mouse or touch to draw</small>
              </div>
            </div>

            <div class="mb-3" id="delayReasonSection">
              <label class="form-label fw-bold text-dark mb-2">
                <i class="fa fa-exclamation-circle me-2 text-danger"></i><span id="delayReasonLabel">Reason for Delays</span> <span id="delayReasonRequired" class="text-danger" style="display:none;">*</span><small class="fw-normal text-muted" id="delayReasonOptionalText"> (optional)</small>
              </label>

              <div class="mb-2">
                <label class="form-label text-muted small">Category</label>
                <select id="delayReasonCategory" name="delay_reason_category" class="form-select">
                  <option value="">-- Select Category --</option>
                  <option value="parts">Parts-Related Delays</option>
                  <option value="technical">Technical / Diagnostic Issues</option>
                  <option value="workload">High Workload / Operational Capacity</option>
                  <option value="customer">Customer-Related Causes</option>
                  <option value="administrative">Administrative / System Issues</option>
                  <option value="quality">Quality-Control & Testing Delays</option>
                  <option value="external">External / Environmental Factors</option>
                </select>
              </div>

              <div class="mb-2">
                <label class="form-label text-muted small">Specific Reason <span id="reasonRequiredBadge" class="badge bg-danger ms-2" style="display:none;">Required</span></label>
                <select id="delayReasonDropdown" name="delay_reason" class="form-select">
                  <option value="">-- Select Specific Reason --</option>
                </select>
                <div id="selectedReasonDisplay" class="alert alert-info mt-2" style="display:none;">
                  <i class="fa fa-check-circle me-2"></i>
                  <strong>Selected:</strong> <span id="selectedReasonText"></span>
                </div>
              </div>

              <div>
                <label class="form-label text-muted small">Additional Comments (optional)</label>
                <textarea id="delayReasonComments" name="delay_reason_comments" class="form-control form-control-sm" rows="2" placeholder="Add any additional details about the delay..."></textarea>
              </div>

              <small class="text-muted d-block mt-2">
                <i class="fa fa-info-circle me-1"></i><span id="delayReasonHelpText">Select the reason if order exceeded 2 hours.</span>
              </small>
            </div>

            <div id="delayReasonError" class="alert alert-danger" style="display:none;"></div>
          </div>
          <div class="modal-footer bg-light">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-success fw-bold">
              <i class="fa fa-check-circle me-2"></i>Complete Order
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Branch Mismatch Modal -->
  <div class="modal fade" id="branchMismatchModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title">Branch Mismatch</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p class="mb-2">You are viewing an order for <strong>{{ order.branch.name }}</strong> while your branch is <strong>{{ user_branch.name }}</strong>.</p>
          <p class="mb-0">Proceed only if you intend to work on this cross-branch order.</p>
        </div>
        <div class="modal-footer bg-light">
          <a href="{% url 'tracker:started_orders_dashboard' %}" class="btn btn-outline-secondary">Back to Started Orders</a>
          <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Continue</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Invoice Upload Modal -->
  {% include 'tracker/partials/invoice_upload_modal.html' %}

  <!-- EDIT ORDER DETAILS MODAL - COMPLETE SELF-CONTAINED SOLUTION -->
  <style>
    /* ============================================
       Edit Order Details Modal - Complete Styles
       ============================================ */

    #editOrderDetailsModal .modal-dialog {
      width: 900px !important;
      max-width: none !important;
      margin: 1.75rem auto !important;
      max-height: calc(100vh - 2rem);
    }

    #editOrderDetailsModal .modal-content {
      border: 1px solid #dee2e6;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
      max-height: calc(100vh - 3.5rem);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background-color: #ffffff;
    }

    #editOrderDetailsModal .modal-header {
      background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%);
      color: white;
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid #dee2e6;
      flex-shrink: 0;
    }

    #editOrderDetailsModal .modal-header .modal-title {
      font-size: 1.1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    #editOrderDetailsModal .btn-close-white {
      filter: brightness(0) invert(1);
    }

    #editOrderDetailsModal .modal-body {
      padding: 1.5rem;
      overflow-y: auto;
      overflow-x: hidden;
      flex: 1;
      min-height: 0;
      max-height: calc(100vh - 250px);
    }

    #editOrderDetailsModal .modal-body::-webkit-scrollbar {
      width: 10px;
    }

    #editOrderDetailsModal .modal-body::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 6px;
    }

    #editOrderDetailsModal .modal-body::-webkit-scrollbar-thumb {
      background: #0d6efd;
      border-radius: 6px;
    }

    #editOrderDetailsModal .modal-body::-webkit-scrollbar-thumb:hover {
      background: #0b5ed7;
    }

    #editOrderDetailsModal .modal-footer {
      border-top: 1px solid #dee2e6;
      padding: 1rem 1.5rem;
      background: #f8f9fa;
      flex-shrink: 0;
      display: flex;
      gap: 0.5rem;
      justify-content: flex-end;
      position: sticky;
      bottom: 0;
      z-index: 10;
      box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.05);
    }

    #editOrderDetailsModal .form-label {
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: #2c3e50;
    }

    #editOrderDetailsModal .form-control,
    #editOrderDetailsModal .form-select {
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 0.5rem 0.75rem;
      font-size: 0.95rem;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    #editOrderDetailsModal .form-control:focus,
    #editOrderDetailsModal .form-select:focus {
      border-color: #0d6efd;
      box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }

    #editOrderDetailsModal .alert-info {
      background-color: #cfe2ff;
      border: 1px solid #b6d4fe;
      color: #084298;
      border-radius: 4px;
      padding: 0.5rem 0.75rem;
      font-size: 0.9rem;
      margin-bottom: 0;
    }

    #editOrderDetailsModal .card {
      border: 1px solid #dee2e6;
      border-radius: 6px;
      background: white;
      overflow: hidden;
    }

    #editOrderDetailsModal .card-body {
      padding: 1rem;
    }

    #editOrderDetailsModal .card.border-light {
      border: 1px solid #f1f3f4 !important;
      background: #fafbfc;
    }

    #editOrderDetailsModal .card.border-light.bg-light {
      background: #f8f9fa;
    }

    #editOrderDetailsModal .nav-tabs {
      border-bottom: 2px solid #dee2e6;
      margin-bottom: 1rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0;
    }

    #editOrderDetailsModal .nav-item {
      margin-right: -1px;
    }

    #editOrderDetailsModal .nav-link {
      border: 1px solid transparent;
      border-bottom: 2px solid transparent;
      color: #6c757d;
      padding: 0.5rem 1rem;
      text-decoration: none;
      transition: all 0.2s ease;
      font-weight: 500;
      font-size: 0.95rem;
    }

    #editOrderDetailsModal .nav-link:hover {
      border-bottom-color: #0d6efd;
      color: #0d6efd;
    }

    #editOrderDetailsModal .nav-link.active {
      border-bottom-color: #0d6efd;
      color: #0d6efd;
      background: transparent;
    }

    #editOrderDetailsModal .tab-content {
      border: none;
    }

    #editOrderDetailsModal .tab-pane {
      padding: 0;
    }

    #editOrderDetailsModal #editServicesContainer {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      max-height: 550px;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 0.75rem;
      margin: -0.75rem;
      width: calc(100% + 1.5rem);
    }

    #editOrderDetailsModal #editServicesContainer::-webkit-scrollbar {
      width: 10px;
    }

    #editOrderDetailsModal #editServicesContainer::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 6px;
    }

    #editOrderDetailsModal #editServicesContainer::-webkit-scrollbar-thumb {
      background: #0d6efd;
      border-radius: 6px;
    }

    #editOrderDetailsModal #editServicesContainer::-webkit-scrollbar-thumb:hover {
      background: #0b5ed7;
    }

    #editOrderDetailsModal .labour-code-col {
      padding: 0;
      width: 100%;
    }

    #editOrderDetailsModal .labour-card-wrapper {
      height: auto;
    }

    #editOrderDetailsModal .labour-code-card {
      position: relative;
      border: 2px solid #e8e8e8;
      border-radius: 8px;
      background: #ffffff;
      padding: 1rem;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      min-height: auto;
      display: flex;
      flex-direction: row;
      justify-content: flex-start;
      align-items: center;
      margin-bottom: 0;
    }

    #editOrderDetailsModal .labour-code-card .labour-check {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
      margin: 0;
      padding: 0;
      z-index: 1;
      top: 0;
      left: 0;
    }

    #editOrderDetailsModal .labour-code-card .labour-icon {
      flex-shrink: 0;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    #editOrderDetailsModal .labour-code-card .labour-title {
      font-weight: 600;
      color: #1a1a1a;
      font-size: 0.95rem;
      margin-bottom: 0.25rem;
      word-break: break-word;
      overflow-wrap: break-word;
      line-height: 1.3;
      hyphens: auto;
    }

    #editOrderDetailsModal .labour-code-card .labour-badge {
      display: inline-block;
      color: white;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.65rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      white-space: nowrap;
    }

    #editOrderDetailsModal .labour-code-card .labour-check-icon {
      color: #27ae60;
      font-size: 1.5rem;
      opacity: 0;
      transition: opacity 0.2s;
      flex-shrink: 0;
    }

    #editOrderDetailsModal .service-col {
      padding: 0;
      width: 100%;
    }

    #editOrderDetailsModal .service-card-wrapper {
      height: auto;
    }

    #editOrderDetailsModal .service-card {
      position: relative;
      border: 2px solid #e8e8e8;
      border-radius: 8px;
      background: #ffffff;
      padding: 1rem;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      min-height: auto;
      display: flex;
      flex-direction: row;
      justify-content: flex-start;
      align-items: center;
      margin-bottom: 0;
    }

    #editOrderDetailsModal .service-card .service-check {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
      margin: 0;
      padding: 0;
      z-index: 1;
      top: 0;
      left: 0;
    }

    #editOrderDetailsModal .service-card .service-icon {
      flex-shrink: 0;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    #editOrderDetailsModal .service-card .service-title {
      font-weight: 600;
      color: #1a1a1a;
      font-size: 0.95rem;
      margin-bottom: 0.25rem;
      word-break: break-word;
      overflow-wrap: break-word;
      line-height: 1.3;
      hyphens: auto;
    }

    #editOrderDetailsModal .service-card .service-badge {
      display: inline-block;
      color: white;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.65rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      white-space: nowrap;
    }

    #editOrderDetailsModal .service-card .service-check-icon {
      font-size: 1.5rem;
      opacity: 0;
      transition: opacity 0.2s;
      flex-shrink: 0;
    }

    #editOrderDetailsModal .labour-code-card:hover,
    #editOrderDetailsModal .service-card:hover {
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
      transform: translateY(-2px);
    }

    #editOrderDetailsModal .labour-code-card.selected,
    #editOrderDetailsModal .service-card.selected {
      border-color: #0d6efd;
      border-width: 2px;
      background-color: #f0f4ff;
      box-shadow: 0 4px 14px rgba(13, 110, 253, 0.4);
    }

    #editOrderDetailsModal .labour-code-card .fa,
    #editOrderDetailsModal .service-card .fa {
      font-size: 1.25rem;
      margin-bottom: 0.5rem;
    }

    #editOrderDetailsModal .labour-code-card i.fa-check-circle,
    #editOrderDetailsModal .service-card i.fa-check-circle {
      position: absolute;
      right: 0.75rem;
      top: 0.75rem;
      font-size: 1.5rem;
      opacity: 0;
      transition: opacity 0.2s ease;
      color: #27ae60;
    }

    #editOrderDetailsModal .labour-code-card.selected i.fa-check-circle,
    #editOrderDetailsModal .service-card.selected i.fa-check-circle {
      opacity: 1;
    }

    #editOrderDetailsModal .form-check {
      margin-bottom: 0;
      width: 100%;
    }

    #editOrderDetailsModal .form-check-label {
      display: block;
      width: 100%;
      cursor: pointer;
      margin-bottom: 0;
      font-weight: 500;
      word-break: break-word;
      overflow-wrap: break-word;
    }

    #editOrderDetailsModal .form-check-input,
    #editOrderDetailsModal .edit-labour-code-checkbox,
    #editOrderDetailsModal .edit-service-checkbox {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
      margin: 0;
      padding: 0;
      z-index: 1;
      top: 0;
      left: 0;
    }

    #editOrderDetailsModal .btn {
      border-radius: 4px;
      padding: 0.5rem 1rem;
      font-weight: 500;
      transition: all 0.2s ease;
      white-space: nowrap;
    }

    #editOrderDetailsModal .btn-primary {
      background-color: #0d6efd;
      border-color: #0d6efd;
    }

    #editOrderDetailsModal .btn-primary:hover {
      background-color: #0b5ed7;
      border-color: #0a58ca;
    }

    #editOrderDetailsModal .btn-secondary {
      background-color: #6c757d;
      border-color: #6c757d;
      color: white;
    }

    #editOrderDetailsModal .btn-secondary:hover {
      background-color: #5c636a;
      border-color: #565e64;
    }

    /* Ensure modal is interactive */
    #editOrderDetailsModal {
      pointer-events: auto;
    }

    #editOrderDetailsModal .modal-dialog {
      pointer-events: auto;
    }

    #editOrderDetailsModal .modal-content {
      pointer-events: auto;
    }

    #editOrderDetailsModal .btn,
    #editOrderDetailsModal .form-control,
    #editOrderDetailsModal .form-select,
    #editOrderDetailsModal button,
    #editOrderDetailsModal input,
    #editOrderDetailsModal select,
    #editOrderDetailsModal textarea {
      pointer-events: auto;
    }

    #editOrderDetailsModal button:not(:disabled),
    #editOrderDetailsModal .btn:not(:disabled),
    #editOrderDetailsModal [type="submit"]:not(:disabled) {
      pointer-events: auto;
      cursor: pointer;
    }

    /* Fixed size - No responsive behavior */
    @media (max-width: 768px) {
      #editOrderDetailsModal .modal-dialog {
        width: 900px !important;
        max-width: none !important;
        margin: 1.75rem auto !important;
      }

      #editOrderDetailsModal .modal-content {
        max-height: calc(100vh - 3.5rem);
      }

      #editOrderDetailsModal .modal-body {
        padding: 1.5rem;
      }
    }

    @media (max-width: 480px) {
      #editOrderDetailsModal .modal-dialog {
        width: 900px !important;
        max-width: none !important;
        margin: 1.75rem auto !important;
      }

      #editOrderDetailsModal .modal-content {
        max-height: calc(100vh - 3.5rem);
      }

      #editOrderDetailsModal .modal-body {
        padding: 1.5rem;
      }
    }

    @media (max-width: 480px) {
      #editOrderDetailsModal .labour-code-col,
      #editOrderDetailsModal .service-col {
        padding: 0;
      }

      #editOrderDetailsModal .labour-code-card,
      #editOrderDetailsModal .service-card {
        padding: 0.75rem !important;
        gap: 0.5rem !important;
        flex-direction: column !important;
        align-items: flex-start !important;
      }

      #editOrderDetailsModal .labour-code-card label,
      #editOrderDetailsModal .service-card label {
        grid-template-columns: 1fr !important;
        gap: 0.5rem !important;
      }

      #editOrderDetailsModal .labour-code-card .labour-icon,
      #editOrderDetailsModal .service-card .service-icon {
        width: 32px;
        height: 32px;
      }

      #editOrderDetailsModal .labour-code-card .labour-icon i,
      #editOrderDetailsModal .service-card .service-icon i {
        font-size: 1rem;
      }

      #editOrderDetailsModal .labour-code-card .labour-check-icon,
      #editOrderDetailsModal .service-card .service-check-icon {
        font-size: 1.1rem;
      }
    }
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-50px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    #editOrderDetailsModal.show .modal-dialog {
      animation: modalSlideIn 0.3s ease-out;
    }
  </style>

  <div class="modal fade" id="editOrderDetailsModal" tabindex="-1" role="dialog" aria-labelledby="editOrderDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="editOrderDetailsModalLabel"><i class="fa fa-list me-2"></i>Edit Order Details</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form id="orderDetailsForm" method="post" action="{% url 'tracker:started_order_detail' order.id %}">
          {% csrf_token %}
          <input type="hidden" name="action" value="update_order_details">
          <div class="modal-body">
            <!-- Order Type Selection -->
            <div class="mb-4">
              <label class="form-label fw-bold">Order Type</label>
              <div class="row g-2">
                <div class="col-md-6">
                  <select id="editOrderType" name="order_type" class="form-select">
                    <option value="service" {% if order.type == 'service' %}selected{% endif %}>üîß Service</option>
                    <option value="sales" {% if order.type == 'sales' %}selected{% endif %}>üõí Sales (Items)</option>
                    <option value="labour" {% if order.type == 'labour' %}selected{% endif %}>üõ†Ô∏è Labour</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <div class="alert alert-info mb-0 py-2">
                    <small id="orderTypeInfo"><i class="fa fa-info-circle me-1"></i>Select appropriate order type</small>
                  </div>
                </div>
              </div>
            </div>

            <!-- Item Selection for Sales Orders -->
            <div id="itemSelectionSection" class="mb-4" style="display:none;">
              <div class="card border-light bg-light">
                <div class="card-body">
                  <label class="form-label fw-bold mb-3"><i class="fa fa-shopping-cart me-2"></i>Select Item</label>

                  <ul class="nav nav-tabs mb-3" role="tablist">
                    <li class="nav-item" role="presentation">
                      <button class="nav-link active" id="labourCodeTab" type="button" role="tab" aria-controls="labourCodePanel" aria-selected="true" data-bs-toggle="tab" data-bs-target="#labourCodePanel">
                        <i class="fa fa-database me-1"></i>Labour Code
                      </button>
                    </li>
                    <li class="nav-item" id="inventoryTabItem" role="presentation">
                      <button class="nav-link" id="inventoryTab" type="button" role="tab" aria-controls="inventoryPanel" aria-selected="false" data-bs-toggle="tab" data-bs-target="#inventoryPanel">
                        <i class="fa fa-box me-1"></i>Inventory
                      </button>
                    </li>
                    <li class="nav-item" role="presentation">
                      <button class="nav-link" id="manualEntryTab" type="button" role="tab" aria-controls="manualEntryPanel" aria-selected="false" data-bs-toggle="tab" data-bs-target="#manualEntryPanel">
                        <i class="fa fa-pen-to-square me-1"></i>Manual Entry
                      </button>
                    </li>
                  </ul>

                  <div class="tab-content">
                    <div class="tab-pane fade show active" id="labourCodePanel" role="tabpanel">
                      <div class="mb-3">
                        <label class="form-label">Search Labour Code</label>
                        <input type="text" id="labourCodeSearch" class="form-control" placeholder="Enter labour code or item name...">
                        <small class="form-text text-muted">Type to search labour codes from database</small>
                      </div>
                      <div id="labourCodeResults" class="mb-3" style="display:none;">
                        <div class="alert alert-info mb-0 py-2">
                          <small><i class="fa fa-spinner fa-spin me-1"></i>Searching labour codes...</small>
                        </div>
                      </div>
                      <div id="labourCodeSelected" style="display:none;">
                        <div class="alert alert-success py-2">
                          <div class="d-flex justify-content-between align-items-center">
                            <div>
                              <strong id="labourCodeSelectedName">Item Name</strong><br>
                              <small>
                                Code: <span id="labourCodeSelectedCode"></span> ‚Ä¢
                                Brand: <span id="labourCodeSelectedBrand"></span>
                              </small>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-danger" id="clearLabourCodeBtn">Clear</button>
                          </div>
                        </div>
                      </div>
                      <input type="hidden" id="labourCodeId" name="labour_code_id">
                    </div>

                    <div class="tab-pane fade" id="inventoryPanel" role="tabpanel">
                      <div class="mb-3">
                        <label class="form-label">Select from Inventory</label>
                        <select id="editOrderItemSelect" name="item_id" class="form-select">
                          <option value="">Loading items...</option>
                        </select>
                        <small class="form-text text-muted">Select existing inventory items</small>
                      </div>
                      <div class="row g-2">
                        <div class="col-md-6">
                          <label class="form-label">Brand</label>
                          <input type="text" id="editOrderBrand" class="form-control" readonly>
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">Quantity</label>
                          <input type="number" id="editOrderQuantity" name="item_quantity" class="form-control" value="1" min="1">
                        </div>
                      </div>
                    </div>

                    <div class="tab-pane fade" id="manualEntryPanel" role="tabpanel">
                      <div class="mb-3">
                        <label class="form-label">Item Name</label>
                        <input type="text" id="itemNameManual" name="item_name_manual" class="form-control" placeholder="Enter item name...">
                      </div>
                      <div class="row g-2">
                        <div class="col-md-6">
                          <label class="form-label">Brand</label>
                          <input type="text" id="itemBrandManual" name="item_brand_manual" class="form-control" placeholder="Enter brand name...">
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">Quantity</label>
                          <input type="number" id="itemQuantityManual" name="item_quantity" class="form-control" value="1" min="1">
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Services/Labour Codes Selection -->
            <div id="servicesSection" class="mb-4" style="display:none;">
              <div class="card border-light">
                <div class="card-body">
                  <label class="form-label fw-bold mb-3">
                    <i class="fa fa-check-circle me-2"></i>
                    <span id="servicesLabel">Services</span>
                  </label>
                  <div id="editServicesContainer" class="row g-2">
                    <div class="col-12 text-muted text-center py-3">
                      <small><i class="fa fa-spinner fa-spin me-1"></i>Loading services...</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Duration -->
            <div class="mb-3">
              <label class="form-label fw-bold">Estimated Duration (minutes)</label>
              <input type="number" name="estimated_duration" id="orderEstimatedDuration" class="form-control" value="{{ order.estimated_duration|default:'' }}" min="0" placeholder="0">
              <small class="text-muted">Auto-calculated based on selected services (optional)</small>
            </div>
          </div>
          <div class="modal-footer bg-light">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary"><i class="fa fa-save me-2"></i>Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Tab Navigation -->
  <ul class="nav nav-tabs mb-3" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
        <i class="fa fa-eye me-2"></i>Overview
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab">
        <i class="fa fa-list me-2"></i>Order Details
      </button>
    </li>
  </ul>

  <!-- Tab Content -->
  <div class="tab-content">
    <div class="tab-pane fade show active" id="overview">
      <div class="row g-3">
        <div class="col-lg-6">
          <div class="card shadow-sm">
            <div class="card-header bg-light">
              <h6 class="mb-0"><i class="fa fa-user me-2"></i>Customer Information</h6>
            </div>
            <div class="card-body">
              <div class="list-group list-group-flush">
                <div class="list-group-item px-0">
                  <small class="text-muted d-block">Name</small>
                  <strong>{{ customer.full_name }}</strong>
                </div>
                <div class="list-group-item px-0">
                  <small class="text-muted d-block">Phone</small>
                  <strong><a href="tel:{{ customer.phone }}">{{ customer.phone }}</a></strong>
                </div>
                {% if customer.email %}
                <div class="list-group-item px-0">
                  <small class="text-muted d-block">Email</small>
                  <strong><a href="mailto:{{ customer.email }}">{{ customer.email }}</a></strong>
                </div>
                {% endif %}
                {% if customer.address %}
                <div class="list-group-item px-0">
                  <small class="text-muted d-block">Address</small>
                  <strong>{{ customer.address }}</strong>
                </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-6">
          <div class="card shadow-sm">
            <div class="card-header bg-light">
              <h6 class="mb-0"><i class="fa fa-car me-2"></i>Vehicle Information</h6>
            </div>
            <div class="card-body">
              {% if vehicle %}
              <div class="list-group list-group-flush">
                <div class="list-group-item px-0">
                  <small class="text-muted d-block">Plate Number</small>
                  <strong>{{ vehicle.plate_number }}</strong>
                </div>
                {% if vehicle.make %}
                <div class="list-group-item px-0">
                  <small class="text-muted d-block">Make</small>
                  <strong>{{ vehicle.make }}</strong>
                </div>
                {% endif %}
                {% if vehicle.model %}
                <div class="list-group-item px-0">
                  <small class="text-muted d-block">Model</small>
                  <strong>{{ vehicle.model }}</strong>
                </div>
                {% endif %}
                {% if vehicle.vehicle_type %}
                <div class="list-group-item px-0">
                  <small class="text-muted d-block">Type</small>
                  <strong>{{ vehicle.vehicle_type }}</strong>
                </div>
                {% endif %}
              </div>
              {% else %}
              <div class="alert alert-warning" role="alert">
                <i class="fa fa-exclamation-triangle me-2"></i>No vehicle information
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="details">
      <div class="card shadow-sm">
        <div class="card-body">
          {% if order.description %}
          <div class="mb-3">
            <small class="text-muted d-block">Description</small>
            <strong>{{ order.description }}</strong>
          </div>
          {% endif %}
          {% if order.estimated_duration %}
          <div class="mb-3">
            <small class="text-muted d-block">Estimated Duration</small>
            <strong>{{ order.estimated_duration }} minutes</strong>
          </div>
          {% endif %}
          {% if order.item_name %}
          <div class="mb-3">
            <small class="text-muted d-block">Item</small>
            <strong>{{ order.item_name }}</strong>
          </div>
          {% endif %}
          {% if order.brand %}
          <div class="mb-3">
            <small class="text-muted d-block">Brand</small>
            <strong>{{ order.brand }}</strong>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Extraction Form Modal -->
{% include 'tracker/modals/extraction_form_modal.html' %}

<!-- Edit Details Modal -->
<div class="modal fade" id="editDetailsModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title"><i class="fa fa-edit me-2"></i><span id="editTitle">Edit Details</span></h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <form id="customerEditForm" method="post" style="display: none;">
        {% csrf_token %}
        <input type="hidden" name="action" value="update_customer">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label fw-bold">Full Name</label>
            <input type="text" name="full_name" class="form-control" value="{{ customer.full_name }}" required>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Phone</label>
            <input type="tel" name="phone" class="form-control" value="{{ customer.phone }}" required>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Email</label>
            <input type="email" name="email" class="form-control" value="{{ customer.email|default:'' }}">
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Address</label>
            <textarea name="address" class="form-control" rows="2">{{ customer.address|default:'' }}</textarea>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Customer Type</label>
            <select name="customer_type" id="editCustomerType" class="form-select">
              <option value="personal" {% if customer.customer_type == 'personal' %}selected{% endif %}>Personal</option>
              <option value="company" {% if customer.customer_type == 'company' %}selected{% endif %}>Company</option>
              <option value="government" {% if customer.customer_type == 'government' %}selected{% endif %}>Government</option>
              <option value="ngo" {% if customer.customer_type == 'ngo' %}selected{% endif %}>NGO</option>
            </select>
          </div>
          <div class="mb-3 {% if customer.customer_type != 'personal' %}d-none{% endif %}" id="editPersonalSubtypeField">
            <label class="form-label fw-bold">Personal Subtype</label>
            <select name="personal_subtype" class="form-select">
              <option value="owner" {% if customer.personal_subtype == 'owner' %}selected{% endif %}>Owner</option>
              <option value="driver" {% if customer.personal_subtype == 'driver' %}selected{% endif %}>Driver</option>
            </select>
          </div>
          <div class="mb-3 {% if customer.customer_type == 'personal' %}d-none{% endif %}" id="editOrganizationField">
            <label class="form-label fw-bold">Organization Name</label>
            <input type="text" name="organization_name" class="form-control" value="{{ customer.organization_name|default:'' }}">
          </div>
          <div class="mb-3 {% if customer.customer_type == 'personal' %}d-none{% endif %}" id="editTaxField">
            <label class="form-label fw-bold">Tax Number (TIN)</label>
            <input type="text" name="tax_number" class="form-control" value="{{ customer.tax_number|default:'' }}">
          </div>
        </div>
        <div class="modal-footer bg-light">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>

      {% if vehicle %}
      <form id="vehicleEditForm" method="post" style="display: none;">
        {% csrf_token %}
        <input type="hidden" name="action" value="update_vehicle">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label fw-bold">Plate Number</label>
            <input type="text" class="form-control" value="{{ vehicle.plate_number }}" readonly>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Vehicle Type</label>
            <input type="text" name="vehicle_type" class="form-control" value="{{ vehicle.vehicle_type|default:'' }}">
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Make</label>
            <input type="text" name="make" class="form-control" value="{{ vehicle.make|default:'' }}">
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Model</label>
            <input type="text" name="model" class="form-control" value="{{ vehicle.model|default:'' }}">
          </div>
        </div>
        <div class="modal-footer bg-light">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
      {% endif %}
    </div>
  </div>
</div>

<!-- COMPLETE INLINE JAVASCRIPT FOR EDIT ORDER DETAILS MODAL -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // ============================================
  // Edit Order Details Modal - Inline Handler
  // ============================================

  const editOrderModal = document.getElementById('editOrderDetailsModal');
  const editOrderTypeEl = document.getElementById('editOrderType');
  const itemSelectionSection = document.getElementById('itemSelectionSection');
  const servicesSection = document.getElementById('servicesSection');
  const servicesLabel = document.getElementById('servicesLabel');
  const editServicesContainer = document.getElementById('editServicesContainer');
  const editOrderItemSelect = document.getElementById('editOrderItemSelect');
  const editOrderBrand = document.getElementById('editOrderBrand');
  const orderTypeInfo = document.getElementById('orderTypeInfo');
  const orderDetailsForm = document.getElementById('orderDetailsForm');
  const labourCodeSearch = document.getElementById('labourCodeSearch');
  const labourCodeResults = document.getElementById('labourCodeResults');
  const labourCodeSelected = document.getElementById('labourCodeSelected');
  const labourCodeId = document.getElementById('labourCodeId');
  const clearLabourCodeBtn = document.getElementById('clearLabourCodeBtn');

  let allServices = { service_types: [], service_addons: [], inventory_items: [], labour_codes: [] };

  // Load services from API
  function loadServicesAndItems() {
    fetch('/tracker/api/orders/service-types/', {
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
      .then(r => r.json())
      .then(data => {
        allServices = data;
        updateOrderTypeUI();
      })
      .catch(err => {
        console.error('Error loading services:', err);
        editServicesContainer.innerHTML = '<div class="col-12 text-danger"><small>Failed to load services</small></div>';
      });
  }

  // Update UI based on order type
  function updateOrderTypeUI() {
    const selectedType = editOrderTypeEl.value;
    const inventoryTabItem = document.getElementById('inventoryTabItem');

    const typeInfoMap = {
      'service': 'Service order - Select labour codes or services to perform',
      'sales': 'Sales order - Select item/tire to sell',
      'labour': 'Labour order - Select labour codes for charges'
    };
    orderTypeInfo.textContent = '‚úì ' + (typeInfoMap[selectedType] || 'Select appropriate order type');

    if (selectedType === 'sales') {
      itemSelectionSection.style.display = 'block';
      servicesLabel.textContent = 'Add-ons';
      renderEditServices(allServices.service_addons || [], 'addon');
      servicesSection.style.display = 'block';
      if (inventoryTabItem) inventoryTabItem.style.display = 'none';
    } else if (selectedType === 'service') {
      itemSelectionSection.style.display = 'none';
      servicesLabel.textContent = 'Labour Codes';
      renderEditLabourCodes(allServices.labour_codes || [], 'service');
      servicesSection.style.display = 'block';
      if (inventoryTabItem) inventoryTabItem.style.display = 'block';
    } else if (selectedType === 'labour') {
      itemSelectionSection.style.display = 'none';
      servicesLabel.textContent = 'Labour Codes';
      renderEditLabourCodes(allServices.labour_codes || [], 'labour');
      servicesSection.style.display = 'block';
      if (inventoryTabItem) inventoryTabItem.style.display = 'block';
    }
  }

  // Render services as cards
  function renderEditServices(services, type) {
    editServicesContainer.innerHTML = '';
    if (!services || services.length === 0) {
      editServicesContainer.innerHTML = '<div class="col-12 text-muted text-center py-3"><small><i class="fa fa-inbox me-2"></i>No ' + (type === 'addon' ? 'add-ons' : 'services') + ' available</small></div>';
      return;
    }

    services.forEach((service, index) => {
      const col = document.createElement('div');
      col.className = 'service-col';
      const checkboxId = `edit_svc_${service.id || service.name.replace(/\s+/g, '_')}`;
      const minutes = service.estimated_minutes || 0;

      col.innerHTML = `
        <div class="service-card-wrapper">
          <div class="form-check service-card mb-0" style="cursor: pointer; position: relative; border: 1px solid #ddd; border-radius: 6px; padding: 1.2rem; background: #fff; transition: all 0.25s ease; box-shadow: 0 1px 3px rgba(0,0,0,0.08); min-height: auto; display: flex; flex-direction: row; align-items: center; gap: 1rem;">
            <input class="form-check-input service-check" type="checkbox" id="${checkboxId}" name="services[]" value="${service.name}" style="position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; top: 0; left: 0; z-index: 1; margin: 0;">
            <label class="form-check-label w-100 mb-0" for="${checkboxId}" style="cursor: pointer; display: grid; grid-template-columns: ${minutes > 0 ? '2fr 1fr 1fr' : '2fr 1fr'}; gap: 2rem; margin-bottom: 0; position: relative; z-index: 0; flex-grow: 1; align-items: center;">
              <!-- Title -->
              <div style="font-weight: 600; color: #222; font-size: 0.95rem; line-height: 1.4; word-break: break-word;">
                ${service.name}
              </div>

              <!-- Minutes (if available) -->
              ${minutes > 0 ? `
              <div style="display: flex; flex-direction: column; gap: 0.3rem; font-size: 0.85rem; color: #666;">
                <span style="font-weight: 500; color: #666;">Duration</span>
                <span style="color: #333; font-weight: 600;">${minutes} min</span>
              </div>
              ` : ''}
            </label>

            <!-- Checkmark icon -->
            <i class="fa fa-check-circle service-check-icon" style="position: absolute; top: 0.8rem; right: 0.8rem; color: #28a745; font-size: 1.5rem; opacity: 0; transition: opacity 0.2s; flex-shrink: 0;"></i>
          </div>
        </div>
      `;
      editServicesContainer.appendChild(col);

      const card = col.querySelector('.service-card');
      const checkbox = col.querySelector('input[type="checkbox"]');
      const checkIcon = col.querySelector('i.service-check-icon');

      card.addEventListener('click', function(e) {
        if (e.target.type !== 'checkbox' && !e.target.closest('input')) {
          checkbox.checked = !checkbox.checked;
          checkbox.dispatchEvent(new Event('change', { bubbles: true }));
        }
      });

      card.addEventListener('mouseenter', function() {
        if (!checkbox.checked) {
          this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.12)';
        }
      });

      card.addEventListener('mouseleave', function() {
        if (!checkbox.checked) {
          this.style.boxShadow = '0 1px 3px rgba(0,0,0,0.08)';
        }
      });

      checkbox.addEventListener('change', function() {
        if (this.checked) {
          card.style.borderColor = '#0d6efd';
          card.style.backgroundColor = '#f0f4ff';
          card.style.boxShadow = '0 4px 12px rgba(13,110,253,0.2)';
          checkIcon.style.opacity = '1';
        } else {
          card.style.borderColor = '#ddd';
          card.style.backgroundColor = '#fff';
          card.style.boxShadow = '0 1px 3px rgba(0,0,0,0.08)';
          checkIcon.style.opacity = '0';
        }
      });
    });
  }

  // Render labour codes as cards
  function renderEditLabourCodes(labourCodes, type) {
    editServicesContainer.innerHTML = '';
    if (!labourCodes || labourCodes.length === 0) {
      editServicesContainer.innerHTML = '<div class="col-12 text-muted text-center py-3"><small><i class="fa fa-tools me-2"></i>No labour codes available</small></div>';
      return;
    }

    labourCodes.forEach((lc, index) => {
      const col = document.createElement('div');
      col.className = 'col-12 labour-code-col';
      const checkboxId = `edit_lc_${lc.id || index}`;

      col.innerHTML = `
        <div class="labour-card-wrapper">
          <div class="form-check labour-code-card mb-0" style="cursor: pointer; position: relative; border: 1px solid #ddd; border-radius: 6px; padding: 1.2rem; background: #fff; transition: all 0.25s ease; box-shadow: 0 1px 3px rgba(0,0,0,0.08); min-height: auto; display: flex; flex-direction: row; align-items: center; gap: 1rem;">
            <input class="form-check-input labour-check" type="checkbox" id="${checkboxId}" name="labour_codes[]" value="${lc.id}" data-code="${lc.code}" data-name="${lc.item_name || lc.description}" data-brand="${lc.brand || 'N/A'}" style="position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; top: 0; left: 0; z-index: 1; margin: 0;">
            <label class="form-check-label w-100 mb-0" for="${checkboxId}" style="cursor: pointer; display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; margin-bottom: 0; position: relative; z-index: 0; flex-grow: 1; align-items: center;">
              <!-- Title -->
              <div style="font-weight: 600; color: #222; font-size: 0.95rem; line-height: 1.4; word-break: break-word;">
                ${lc.item_name || lc.description}
              </div>

              <!-- Code -->
              <div style="display: flex; flex-direction: column; gap: 0.3rem; font-size: 0.85rem; color: #666;">
                <span style="font-weight: 500; color: #666;">Code</span>
                <span style="color: #333; font-weight: 600;">${lc.code}</span>
              </div>
            </label>

            <!-- Checkmark icon -->
            <i class="fa fa-check-circle labour-check-icon" style="position: absolute; top: 0.8rem; right: 0.8rem; color: #28a745; font-size: 1.5rem; opacity: 0; transition: opacity 0.2s; flex-shrink: 0;"></i>
          </div>
        </div>
      `;
      editServicesContainer.appendChild(col);

      const card = col.querySelector('.labour-code-card');
      const checkbox = col.querySelector('input[type="checkbox"]');
      const checkIcon = col.querySelector('i.labour-check-icon');

      card.addEventListener('click', function(e) {
        if (e.target.type !== 'checkbox' && !e.target.closest('input')) {
          checkbox.checked = !checkbox.checked;
          checkbox.dispatchEvent(new Event('change', { bubbles: true }));
        }
      });

      card.addEventListener('mouseenter', function() {
        if (!checkbox.checked) {
          this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.12)';
        }
      });

      card.addEventListener('mouseleave', function() {
        if (!checkbox.checked) {
          this.style.boxShadow = '0 1px 3px rgba(0,0,0,0.08)';
        }
      });

      checkbox.addEventListener('change', function() {
        if (this.checked) {
          card.style.borderColor = '#0d6efd';
          card.style.backgroundColor = '#f0f4ff';
          card.style.boxShadow = '0 4px 12px rgba(13,110,253,0.2)';
          checkIcon.style.opacity = '1';
        } else {
          card.style.borderColor = '#ddd';
          card.style.backgroundColor = '#fff';
          card.style.boxShadow = '0 1px 3px rgba(0,0,0,0.08)';
          checkIcon.style.opacity = '0';
        }
      });
    });
  }

  // Populate inventory dropdown
  function populateItemDropdown() {
    const items = allServices.inventory_items || [];
    editOrderItemSelect.innerHTML = '<option value="">Select item...</option>';
    items.forEach(item => {
      const option = document.createElement('option');
      option.value = item.id;
      option.textContent = `${item.name} (${item.brand})`;
      editOrderItemSelect.appendChild(option);
    });
  }

  // Labour code search debounce
  function debounce(func, wait) {
    let timeout;
    return function(...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => func(...args), wait);
    };
  }

  const searchLabourCodes = debounce(function() {
    const searchTerm = labourCodeSearch.value.trim();
    if (!searchTerm || searchTerm.length < 2) {
      labourCodeResults.style.display = 'none';
      return;
    }
    fetch(`/tracker/api/orders/lookup-labour-code/?item_name=${encodeURIComponent(searchTerm)}`, {
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
      .then(r => r.json())
      .then(data => {
        if (data.success && data.labour_codes && data.labour_codes.length > 0) {
          labourCodeResults.innerHTML = '';
          data.labour_codes.forEach(lc => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'btn btn-outline-primary btn-sm w-100 mb-2 text-start';
            btn.innerHTML = `<strong>${lc.item_name || lc.description}</strong><br><small>Code: ${lc.code} ‚Ä¢ Brand: ${lc.brand || 'N/A'}</small>`;
            btn.onclick = function(e) {
              e.preventDefault();
              selectLabourCode(lc);
            };
            labourCodeResults.appendChild(btn);
          });
          labourCodeResults.style.display = 'block';
        } else {
          labourCodeResults.innerHTML = '<div class="alert alert-warning mb-0 py-2"><small>No labour codes found</small></div>';
          labourCodeResults.style.display = 'block';
        }
      })
      .catch(err => {
        console.error('Error searching labour codes:', err);
        labourCodeResults.innerHTML = '<div class="alert alert-danger mb-0 py-2"><small>Error searching labour codes</small></div>';
        labourCodeResults.style.display = 'block';
      });
  }, 300);

  function selectLabourCode(lc) {
    labourCodeId.value = lc.id;
    document.getElementById('labourCodeSelectedCode').textContent = lc.code;
    document.getElementById('labourCodeSelectedName').textContent = lc.item_name || lc.description;
    document.getElementById('labourCodeSelectedBrand').textContent = lc.brand || 'N/A';
    labourCodeResults.style.display = 'none';
    labourCodeSearch.value = lc.item_name || lc.description;
    labourCodeSelected.style.display = 'block';
  }

  if (clearLabourCodeBtn) {
    clearLabourCodeBtn.addEventListener('click', function(e) {
      e.preventDefault();
      labourCodeId.value = '';
      labourCodeSearch.value = '';
      labourCodeSelected.style.display = 'none';
      labourCodeResults.style.display = 'none';
    });
  }

  if (labourCodeSearch) {
    labourCodeSearch.addEventListener('input', searchLabourCodes);
  }

  if (editOrderTypeEl) {
    editOrderTypeEl.addEventListener('change', updateOrderTypeUI);
  }

  if (editOrderItemSelect) {
    editOrderItemSelect.addEventListener('change', function(e) {
      const itemId = e.target.value;
      if (itemId) {
        const item = allServices.inventory_items.find(i => i.id == itemId);
        if (item) {
          editOrderBrand.value = item.brand || 'Unbranded';
        }
      } else {
        editOrderBrand.value = '';
      }
    });
  }

  // Form submission
  if (orderDetailsForm) {
    orderDetailsForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      const submitBtn = this.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerHTML;
      const formAction = this.getAttribute('action');

      console.log('Form Action URL:', formAction);
      console.log('Form Method:', this.method);
      console.log('All form fields:');
      for (let [key, value] of formData.entries()) {
        if (key !== 'csrfmiddlewaretoken') {
          console.log(`  ${key}: ${typeof value === 'string' ? value.substring(0, 50) : 'File/Blob'}`);
        }
      }

      submitBtn.innerHTML = '<i class="fa fa-spinner fa-spin me-2"></i>Saving...';
      submitBtn.disabled = true;

      const csrfToken = document.querySelector('[name="csrfmiddlewaretoken"]')?.value || '';

      fetch(formAction, {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': csrfToken
        }
      })
        .then(r => {
          console.log('Response status:', r.status);
          if (r.ok || r.status === 302 || r.status === 301 || r.status === 307 || r.status === 308) {
            setTimeout(() => {
              window.location.reload();
            }, 500);
          } else if (r.status === 404) {
            console.error('404 Error: Endpoint not found at', formAction);
            alert('Error: The update endpoint was not found (404). Please check your URL configuration.');
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
          } else {
            console.error('Request failed with status:', r.status);
            alert('Failed to update order details. Status: ' + r.status);
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
          }
        })
        .catch(error => {
          console.error('Error submitting form:', error);
          alert('An error occurred. Please try again. Check browser console for details.');
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        });
    });
  }

  // Load initial data
  loadServicesAndItems();
});

// Customer Edit Mode
let currentEditMode = 'customer';

function setEditMode(mode) {
  currentEditMode = mode;
  document.getElementById('customerEditForm').style.display = 'none';
  if (document.getElementById('vehicleEditForm')) {
    document.getElementById('vehicleEditForm').style.display = 'none';
  }

  if (mode === 'customer') {
    document.getElementById('editTitle').textContent = 'Edit Customer Information';
    document.getElementById('customerEditForm').style.display = 'block';
    if (typeof toggleCustomerExtraFields === 'function') {
      toggleCustomerExtraFields();
    }
  } else if (mode === 'vehicle') {
    document.getElementById('editTitle').textContent = 'Edit Vehicle Information';
    document.getElementById('vehicleEditForm').style.display = 'block';
  }
}

function toggleCustomerExtraFields() {
  const sel = document.getElementById('editCustomerType');
  const type = sel ? String(sel.value).toLowerCase() : '';
  const personal = document.getElementById('editPersonalSubtypeField');
  const org = document.getElementById('editOrganizationField');
  const tax = document.getElementById('editTaxField');

  if (personal) {
    if (type === 'personal') {
      personal.classList.remove('d-none');
    } else {
      personal.classList.add('d-none');
    }
  }

  const showOrg = type === 'company' || type === 'government' || type === 'ngo';
  if (org) {
    if (showOrg) {
      org.classList.remove('d-none');
    } else {
      org.classList.add('d-none');
    }
  }
  if (tax) {
    if (showOrg) {
      tax.classList.remove('d-none');
    } else {
      tax.classList.add('d-none');
    }
  }
}

const editCustomerTypeEl = document.getElementById('editCustomerType');
if (editCustomerTypeEl) {
  editCustomerTypeEl.addEventListener('change', toggleCustomerExtraFields);
  toggleCustomerExtraFields();
}

// Complete Order Modal Logic
document.addEventListener('DOMContentLoaded', function() {
  const completeBtn = document.getElementById('completeOrderBtn');
  if (!completeBtn) return;

  const completeOrderModalEl = document.getElementById('completeOrderModal');
  const completeOrderForm = document.getElementById('completeOrderForm');
  const delayReasonCategory = document.getElementById('delayReasonCategory');
  const delayReasonDropdown = document.getElementById('delayReasonDropdown');

  const delayReasonsByCategoryJson = {};
  try {
    const delayReasonsJsonString = '{{ delay_reasons_by_category|escapejs }}';
    if (delayReasonsJsonString && delayReasonsJsonString.trim()) {
      const delayReasonsData = JSON.parse(delayReasonsJsonString);
      Object.assign(delayReasonsByCategoryJson, delayReasonsData);
    }
  } catch (e) {
    console.error('Error parsing delay reasons:', e);
  }

  const exceeds9Hours = {{ exceeds_9_hours|lower|default:"false" }};

  function populateReasons(category) {
    delayReasonDropdown.innerHTML = '<option value="">-- Select Specific Reason --</option>';
    if (category && delayReasonsByCategoryJson[category]) {
      delayReasonsByCategoryJson[category].forEach(reason => {
        const option = document.createElement('option');
        option.value = reason.id;
        option.textContent = reason.reason_text;
        delayReasonDropdown.appendChild(option);
      });
    }
  }

  if (delayReasonCategory) {
    delayReasonCategory.addEventListener('change', function() {
      populateReasons(this.value);
      delayReasonDropdown.value = '';
    });
  }

  if (completeOrderForm) {
    completeOrderForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const canvas = document.getElementById('completionSignaturePad');
      const signatureDataInput = document.getElementById('signatureDataInput');
      if (canvas) {
        try {
          const signatureDataUrl = canvas.toDataURL('image/png', 0.8);
          signatureDataInput.value = signatureDataUrl;
        } catch (err) {
          console.warn('Could not capture signature:', err);
        }
      }
      completeOrderForm.submit();
    });
  }

  completeBtn.addEventListener('click', function(e) {
    e.preventDefault();
    if (completeOrderModalEl) {
      const modal = new bootstrap.Modal(completeOrderModalEl);
      modal.show();
    }
  });
});

// Signature Pad
function initializeSignaturePad() {
  const canvas = document.getElementById('completionSignaturePad');
  if (!canvas) return;

  const ctx = canvas.getContext('2d');
  let isDrawing = false;
  let lastX = 0;
  let lastY = 0;

  function resizeCanvas() {
    const container = canvas.parentElement;
    const rect = container.getBoundingClientRect();
    canvas.width = rect.width - 8;
    canvas.height = 200;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.lineWidth = 2;
    ctx.strokeStyle = '#000';
  }

  resizeCanvas();

  function getCoordinates(e) {
    const rect = canvas.getBoundingClientRect();
    const x = (e.clientX || e.touches?.[0]?.clientX) - rect.left;
    const y = (e.clientY || e.touches?.[0]?.clientY) - rect.top;
    return { x, y };
  }

  function startDrawing(e) {
    isDrawing = true;
    const { x, y } = getCoordinates(e);
    lastX = x;
    lastY = y;
  }

  function draw(e) {
    if (!isDrawing) return;
    e.preventDefault();
    const { x, y } = getCoordinates(e);
    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(x, y);
    ctx.stroke();
    lastX = x;
    lastY = y;
  }

  function stopDrawing() {
    isDrawing = false;
  }

  canvas.addEventListener('mousedown', startDrawing);
  canvas.addEventListener('mousemove', draw);
  canvas.addEventListener('mouseup', stopDrawing);
  canvas.addEventListener('mouseleave', stopDrawing);
  canvas.addEventListener('touchstart', startDrawing, { passive: false });
  canvas.addEventListener('touchmove', draw, { passive: false });
  canvas.addEventListener('touchend', stopDrawing, { passive: false });

  const clearBtn = document.getElementById('clearCompletionSignature');
  if (clearBtn) {
    clearBtn.addEventListener('click', function(e) {
      e.preventDefault();
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    });
  }
}

document.addEventListener('DOMContentLoaded', function() {
  initializeSignaturePad();

  // Branch mismatch modal
  try {
    const mismatch = {{ branch_mismatch|yesno:'true,false' }};
    if (mismatch) {
      const bmEl = document.getElementById('branchMismatchModal');
      if (bmEl) {
        const modal = new bootstrap.Modal(bmEl);
        modal.show();
      }
    }
  } catch (e) {}

  // Upload Invoice Button Handler
  const uploadInvoiceBtn = document.getElementById('uploadInvoiceBtn');
  const uploadInvoiceModal = document.getElementById('uploadInvoiceModal');

  if (uploadInvoiceBtn && uploadInvoiceModal) {
    const modal = new bootstrap.Modal(uploadInvoiceModal);
    uploadInvoiceBtn.addEventListener('click', function(e) {
      e.preventDefault();
      modal.show();
    });
  }
});
</script>

{% endblock %}
