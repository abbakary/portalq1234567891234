{% extends 'tracker/base.html' %}
{% load date_filters %}
{% load custom_filters %}
{% load static %}

{% block title %}User Management{% endblock %}

{% block content %}
<style>
  .users-container {
    padding: 20px 0;
  }

  .user-card {
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 12px;
    background: #fff;
    transition: box-shadow 0.2s ease, transform 0.2s ease;
  }

  .user-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
  }

  .user-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 12px;
  }

  .user-info {
    flex: 1;
  }

  .username {
    font-size: 16px;
    font-weight: 600;
    color: #333;
    margin-bottom: 4px;
  }

  .user-detail {
    font-size: 13px;
    color: #666;
    margin: 4px 0;
  }

  .user-roles {
    display: flex;
    gap: 6px;
    margin-top: 8px;
    flex-wrap: wrap;
  }

  .role-badge {
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }

  .role-superuser {
    background: #ff6b6b;
    color: white;
  }

  .role-staff {
    background: #4c6ef5;
    color: white;
  }

  .role-manager {
    background: #9c36b5;
    color: white;
  }

  .role-active {
    background: #51cf66;
    color: white;
  }

  .role-inactive {
    background: #a8a8a8;
    color: white;
  }

  .user-branch {
    display: inline-block;
    padding: 4px 10px;
    background: #f0f0f0;
    border-radius: 4px;
    font-size: 12px;
    color: #333;
    margin-top: 8px;
  }

  .user-branch-icon {
    margin-right: 4px;
    color: #666;
  }

  .user-actions {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .action-btn {
    padding: 6px 12px;
    font-size: 12px;
    border-radius: 4px;
    text-decoration: none;
    border: 1px solid #ddd;
    background: #fff;
    color: #333;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .action-btn:hover {
    background: #f5f5f5;
    border-color: #999;
  }

  .action-btn-edit {
    color: #0066cc;
    border-color: #0066cc;
  }

  .action-btn-edit:hover {
    background: #f0f7ff;
  }

  .action-btn-toggle {
    color: #ff9500;
    border-color: #ff9500;
  }

  .action-btn-toggle:hover {
    background: #fffbf0;
  }

  .action-btn-delete {
    color: #ff4444;
    border-color: #ff4444;
  }

  .action-btn-delete:hover {
    background: #ffe6e6;
  }

  .filters-section {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
    align-items: center;
    flex-wrap: wrap;
  }

  .filters-section form {
    display: flex;
    gap: 8px;
    flex: 1;
  }

  .search-input {
    flex: 1;
    min-width: 200px;
  }

  .add-user-btn {
    padding: 10px 20px;
    background: #51cf66;
    color: white;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
    display: inline-block;
  }

  .add-user-btn:hover {
    background: #40c057;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(81, 207, 102, 0.3);
  }

  .branch-filter {
    min-width: 150px;
  }

  .empty-state {
    text-align: center;
    padding: 40px;
    color: #999;
  }

  .empty-state-icon {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.5;
  }

  .header-section {
    margin-bottom: 24px;
  }

  .header-title {
    font-size: 28px;
    font-weight: 700;
    color: #333;
    margin-bottom: 8px;
  }

  .header-subtitle {
    font-size: 14px;
    color: #666;
  }

  @media (max-width: 768px) {
    .user-card-header {
      flex-direction: column;
    }

    .user-actions {
      width: 100%;
      margin-top: 12px;
    }

    .filters-section {
      flex-direction: column;
    }

    .filters-section form {
      flex-direction: column;
      width: 100%;
    }

    .search-input {
      width: 100%;
    }

    .branch-filter {
      width: 100%;
    }
  }
</style>

<div class="container-fluid users-container">
  <div class="header-section">
    <div class="header-title">Users</div>
    <div class="header-subtitle">
      {% if user_branch %}
        {% if user_branch.is_main_branch %}
          Managing users for main branch <strong>{{ user_branch.name }}</strong> and its sub-branches
        {% else %}
          Managing users for sub-branch <strong>{{ user_branch.name }}</strong>
        {% endif %}
      {% else %}
        All users across all branches
      {% endif %}
    </div>
  </div>

  <div class="filters-section">
    <form method="get" class="flex-grow-1">
      <input 
        type="text" 
        name="q" 
        value="{{ q }}" 
        placeholder="Search by username, name, or email"
        class="form-control search-input"
      >
      <button type="submit" class="btn btn-outline-primary">Search</button>
    </form>

    {% if branches %}
      <select name="branch" class="form-select branch-filter" onchange="window.location.href='?branch=' + this.value">
        <option value="">All Branches</option>
        {% for branch_id, branch_name in branches %}
          <option value="{{ branch_id }}" {% if selected_branch == branch_id %}selected{% endif %}>{{ branch_name }}</option>
        {% endfor %}
      </select>
    {% endif %}

    <a href="{% url 'tracker:user_create' %}" class="add-user-btn">
      <i class="fa fa-plus" style="margin-right: 6px;"></i>Add User
    </a>
  </div>

  {% if users %}
    <div class="users-list">
      {% for u in users %}
        <div class="user-card">
          <div class="user-card-header">
            <div class="user-info">
              <div class="username">{{ u.username }}</div>
              
              <div class="user-detail">
                {% if u.first_name or u.last_name %}
                  <i class="fa fa-user" style="margin-right: 4px; color: #999;"></i>
                  {{ u.first_name }} {{ u.last_name }}
                {% endif %}
              </div>

              {% if u.email %}
                <div class="user-detail">
                  <i class="fa fa-envelope" style="margin-right: 4px; color: #999;"></i>
                  {{ u.email }}
                </div>
              {% endif %}

              <div class="user-roles">
                {% if u.is_superuser %}
                  <span class="role-badge role-superuser">Superuser</span>
                {% endif %}

                {% if u.is_staff and not u.is_superuser %}
                  <span class="role-badge role-staff">Staff</span>
                {% endif %}

                {% with u.profile.role as user_role %}
                  {% if user_role %}
                    <span class="role-badge" style="background: #6c63ff; color: white;">
                      {{ user_role|upper|replace:"_: " }}
                    </span>
                  {% endif %}
                {% endwith %}

                {% if u.groups.all %}
                  {% for group in u.groups.all %}
                    <span class="role-badge role-manager">{{ group.name }}</span>
                  {% endfor %}
                {% endif %}

                {% if u.is_active %}
                  <span class="role-badge role-active">Active</span>
                {% else %}
                  <span class="role-badge role-inactive">Inactive</span>
                {% endif %}
              </div>

              {% with u.profile.branch as branch %}
                {% if branch %}
                  <div class="user-branch">
                    {% if branch.parent %}
                      <i class="fa fa-arrow-right user-branch-icon" style="color: #0066cc;"></i>
                      <strong>{{ branch.parent.name }}</strong> → {{ branch.name }}
                    {% else %}
                      <i class="fa fa-map-marker user-branch-icon"></i>
                      {{ branch.name }}
                    {% endif %}
                    {% if branch.region %}
                      <span style="color: #999;">— {{ branch.region }}</span>
                    {% endif %}
                  </div>
                {% else %}
                  <div class="user-branch" style="color: #999; font-style: italic;">
                    <i class="fa fa-warning user-branch-icon"></i>
                    No branch assigned
                  </div>
                {% endif %}
              {% endwith %}

              <div class="user-detail" style="margin-top: 8px; font-size: 12px; color: #999;">
                <i class="fa fa-clock-o" style="margin-right: 4px;"></i>
                Joined: {{ u.date_joined|date:'M d, Y' }}
              </div>
            </div>

            <div class="user-actions">
              <a href="{% url 'tracker:user_edit' u.pk %}" class="action-btn action-btn-edit">
                <i class="fa fa-edit"></i> Edit
              </a>
              <form method="post" action="{% url 'tracker:user_toggle_active' u.pk %}" style="display: inline;">
                {% csrf_token %}
                {% if u.is_active %}
                  <button type="submit" class="action-btn action-btn-toggle" onclick="return confirm('Deactivate this user?')">
                    <i class="fa fa-lock"></i> Deactivate
                  </button>
                {% else %}
                  <button type="submit" class="action-btn action-btn-toggle" onclick="return confirm('Activate this user?')">
                    <i class="fa fa-unlock"></i> Activate
                  </button>
                {% endif %}
              </form>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="empty-state">
      <div class="empty-state-icon">
        <i class="fa fa-users"></i>
      </div>
      <h4>No Users Found</h4>
      <p>
        {% if q %}
          No users match your search. Try different keywords.
        {% else %}
          No users available. <a href="{% url 'tracker:user_create' %}">Create one now</a>
        {% endif %}
      </p>
    </div>
  {% endif %}
</div>
{% endblock %}
